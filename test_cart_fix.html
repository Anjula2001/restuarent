<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cart Image Fix Test</title>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; background: #f5f5f5; }
        .test-container { max-width: 800px; margin: 0 auto; background: white; padding: 20px; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        .test-section { margin-bottom: 30px; padding: 20px; border: 1px solid #ddd; border-radius: 8px; }
        .success { background: #e8f5e8; border-color: #4caf50; }
        .error { background: #ffe8e8; border-color: #f44336; }
        .info { background: #e8f4fd; border-color: #2196f3; }
        .test-item { margin: 10px 0; padding: 15px; background: #f9f9f9; border-radius: 5px; }
        button { padding: 10px 20px; margin: 5px; background: #007bff; color: white; border: none; border-radius: 5px; cursor: pointer; }
        button:hover { background: #0056b3; }
        .image-preview { max-width: 200px; max-height: 150px; margin: 10px 0; border: 2px solid #ddd; border-radius: 5px; }
        pre { background: #f4f4f4; padding: 10px; border-radius: 5px; overflow-x: auto; }
        .cart-display { margin-top: 20px; padding: 15px; background: #f0f8ff; border-radius: 5px; }
    </style>
</head>
<body>
    <div class="test-container">
        <h1>üõí Cart Image Fix - Live Test</h1>
        
        <div class="test-section info">
            <h2>üìã Test Overview</h2>
            <p>This test verifies that uploaded menu items preserve their correct image URLs through the cart system.</p>
            <p><strong>Expected Behavior:</strong> Uploaded images should show their actual paths (e.g., uploads/menu-items/...) not fallback paths (e.g., images/popular/...).</p>
        </div>

        <div class="test-section" id="api-test">
            <h2>üîå Step 1: API Data Test</h2>
            <button onclick="testAPI()">Load Menu Items from API</button>
            <div id="api-results"></div>
        </div>

        <div class="test-section" id="function-test">
            <h2>üõ†Ô∏è Step 2: Function Availability Test</h2>
            <button onclick="testFunctions()">Check Cart Functions</button>
            <div id="function-results"></div>
        </div>

        <div class="test-section" id="cart-test">
            <h2>üõí Step 3: Add to Cart Test</h2>
            <button onclick="testAddToCart()">Test Adding Uploaded Item to Cart</button>
            <div id="cart-results"></div>
        </div>

        <div class="test-section" id="display-test">
            <h2>üì∫ Step 4: Cart Display Test</h2>
            <button onclick="testCartDisplay()">Test Cart Item Display</button>
            <div id="display-results"></div>
        </div>

        <div class="test-section" id="order-simulation">
            <h2>üçΩÔ∏è Step 5: Order Page Simulation</h2>
            <button onclick="simulateOrderPage()">Simulate Order Page Display</button>
            <div id="order-results"></div>
        </div>

        <div class="cart-display" id="live-cart">
            <h3>üõí Live Cart Contents</h3>
            <div id="cart-contents">Cart is empty</div>
        </div>
    </div>

    <script src="js/script.js"></script>
    <script>
        let testMenuItems = [];

        // Test 1: Load menu items from API
        async function testAPI() {
            const resultsDiv = document.getElementById('api-results');
            resultsDiv.innerHTML = '<p>üîÑ Loading menu items...</p>';
            
            try {
                const response = await fetch('api/menu.php');
                testMenuItems = await response.json();
                
                let html = '<h3>‚úÖ API Response Success</h3>';
                html += `<p>Found <strong>${testMenuItems.length}</strong> menu items:</p>`;
                
                testMenuItems.forEach(item => {
                    html += `<div class="test-item">
                        <strong>ID:</strong> ${item.id}<br>
                        <strong>Name:</strong> ${item.name}<br>
                        <strong>Price:</strong> $${item.price}<br>
                        <strong>Image URL:</strong> <code>${item.image_url || 'No image'}</code><br>
                        ${item.image_url ? `<img src="${item.image_url}" class="image-preview" alt="${item.name}">` : ''}
                    </div>`;
                });
                
                resultsDiv.innerHTML = html;
                resultsDiv.parentElement.className = 'test-section success';
            } catch (error) {
                resultsDiv.innerHTML = `<h3>‚ùå API Error</h3><p>${error.message}</p>`;
                resultsDiv.parentElement.className = 'test-section error';
            }
        }

        // Test 2: Check function availability
        function testFunctions() {
            const resultsDiv = document.getElementById('function-results');
            
            const functions = [
                'addToCartWithQuantity',
                'addMenuItemToCart',
                'displayOrderItems',
                'getCartItems'
            ];
            
            let html = '<h3>üîç Function Availability Check</h3>';
            let allAvailable = true;
            
            functions.forEach(funcName => {
                const available = typeof window[funcName] === 'function';
                html += `<div class="test-item">
                    <strong>${funcName}:</strong> ${available ? '‚úÖ Available' : '‚ùå Not Found'}
                </div>`;
                if (!available) allAvailable = false;
            });
            
            resultsDiv.innerHTML = html;
            resultsDiv.parentElement.className = allAvailable ? 'test-section success' : 'test-section error';
        }

        // Test 3: Add items to cart
        function testAddToCart() {
            const resultsDiv = document.getElementById('cart-results');
            
            if (testMenuItems.length === 0) {
                resultsDiv.innerHTML = '<p>‚ùå Please run API test first</p>';
                return;
            }
            
            // Clear cart first
            localStorage.removeItem('cart');
            
            let html = '<h3>üõí Adding Items to Cart</h3>';
            
            testMenuItems.forEach(item => {
                try {
                    // Test the new function if available
                    if (typeof addMenuItemToCart === 'function') {
                        addMenuItemToCart(item.id, item.name, item.price, item.image_url || 'images/popular/2.png');
                        html += `<div class="test-item">
                            ‚úÖ Added: <strong>${item.name}</strong><br>
                            Image URL: <code>${item.image_url || 'images/popular/2.png'}</code>
                        </div>`;
                    } else {
                        html += `<div class="test-item">‚ùå addMenuItemToCart function not available</div>`;
                    }
                } catch (error) {
                    html += `<div class="test-item">‚ùå Error adding ${item.name}: ${error.message}</div>`;
                }
            });
            
            resultsDiv.innerHTML = html;
            resultsDiv.parentElement.className = 'test-section success';
            
            // Update live cart display
            updateLiveCart();
        }

        // Test 4: Display cart items
        function testCartDisplay() {
            const resultsDiv = document.getElementById('display-results');
            
            try {
                const cart = JSON.parse(localStorage.getItem('cart') || '[]');
                
                let html = '<h3>üì∫ Cart Display Test</h3>';
                html += `<p>Cart contains <strong>${cart.length}</strong> items:</p>`;
                
                cart.forEach(item => {
                    html += `<div class="test-item">
                        <strong>Name:</strong> ${item.name}<br>
                        <strong>Price:</strong> $${item.price}<br>
                        <strong>Quantity:</strong> ${item.quantity}<br>
                        <strong>Image URL:</strong> <code>${item.image}</code><br>
                        <strong>Type Analysis:</strong> ${analyzeImageType(item.image)}<br>
                        ${item.image ? `<img src="${item.image}" class="image-preview" alt="${item.name}" onerror="this.style.border='2px solid red';">` : ''}
                    </div>`;
                });
                
                resultsDiv.innerHTML = html;
                resultsDiv.parentElement.className = 'test-section success';
            } catch (error) {
                resultsDiv.innerHTML = `<h3>‚ùå Display Error</h3><p>${error.message}</p>`;
                resultsDiv.parentElement.className = 'test-section error';
            }
        }

        // Test 5: Simulate order page
        function simulateOrderPage() {
            const resultsDiv = document.getElementById('order-results');
            
            try {
                const cart = JSON.parse(localStorage.getItem('cart') || '[]');
                
                let html = '<h3>üçΩÔ∏è Order Page Simulation</h3>';
                html += '<p>This simulates how items would appear on the order page:</p>';
                
                if (cart.length === 0) {
                    html += '<p>‚ùå Cart is empty. Please add items first.</p>';
                } else {
                    html += '<div style="border: 1px solid #ccc; padding: 15px; background: white; border-radius: 5px;">';
                    html += '<h4>üõí Your Items</h4>';
                    
                    cart.forEach(item => {
                        html += `<div style="display: flex; align-items: center; margin: 10px 0; padding: 10px; border-bottom: 1px solid #eee;">
                            <img src="${item.image}" style="width: 60px; height: 60px; object-fit: cover; border-radius: 5px; margin-right: 15px;" 
                                 onerror="this.style.border='2px solid red'; this.title='Image failed to load: ${item.image}';">
                            <div>
                                <strong>${item.name}</strong><br>
                                $${item.price} x ${item.quantity}<br>
                                <small style="color: #666;">Image: ${item.image}</small>
                            </div>
                        </div>`;
                    });
                    
                    html += '</div>';
                }
                
                resultsDiv.innerHTML = html;
                resultsDiv.parentElement.className = 'test-section success';
            } catch (error) {
                resultsDiv.innerHTML = `<h3>‚ùå Simulation Error</h3><p>${error.message}</p>`;
                resultsDiv.parentElement.className = 'test-section error';
            }
        }

        // Helper function to analyze image type
        function analyzeImageType(imageUrl) {
            if (!imageUrl) return '‚ùå No image URL';
            if (imageUrl.includes('uploads/menu-items/')) return '‚úÖ Uploaded image (CORRECT)';
            if (imageUrl.includes('images/popular/')) return '‚ö†Ô∏è Fallback image (MAY BE INCORRECT)';
            return '‚ùì Unknown image type';
        }

        // Update live cart display
        function updateLiveCart() {
            const cartDiv = document.getElementById('cart-contents');
            
            try {
                const cart = JSON.parse(localStorage.getItem('cart') || '[]');
                
                if (cart.length === 0) {
                    cartDiv.innerHTML = 'Cart is empty';
                } else {
                    let html = '';
                    cart.forEach(item => {
                        html += `<div style="margin: 5px 0; padding: 10px; background: #f9f9f9; border-radius: 3px;">
                            <strong>${item.name}</strong> - $${item.price} x ${item.quantity}<br>
                            <small style="color: #666;">Image: ${item.image}</small>
                        </div>`;
                    });
                    cartDiv.innerHTML = html;
                }
            } catch (error) {
                cartDiv.innerHTML = `Error: ${error.message}`;
            }
        }

        // Auto-update cart display every 2 seconds
        setInterval(updateLiveCart, 2000);
        
        // Initial cart display
        updateLiveCart();
    </script>
</body>
</html>
