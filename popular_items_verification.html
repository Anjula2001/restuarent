<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Popular Items Verification Test</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; background: #f5f5f5; }
        .container { max-width: 1200px; margin: 0 auto; }
        .test-section { background: white; margin: 20px 0; padding: 20px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .status { padding: 10px; margin: 10px 0; border-radius: 4px; font-weight: bold; }
        .success { background: #d4edda; color: #155724; }
        .error { background: #f8d7da; color: #721c24; }
        .warning { background: #fff3cd; color: #856404; }
        .info { background: #d1ecf1; color: #0c5460; }
        .item-card { border: 1px solid #ddd; margin: 10px; padding: 15px; border-radius: 8px; display: inline-block; width: 300px; vertical-align: top; }
        .item-card h4 { margin: 0 0 10px 0; color: #333; }
        .item-card img { width: 100%; height: 150px; object-fit: cover; border-radius: 4px; }
        button { background: #007bff; color: white; border: none; padding: 12px 24px; margin: 5px; border-radius: 5px; cursor: pointer; }
        button:hover { background: #0056b3; }
        .comparison-table { width: 100%; border-collapse: collapse; margin: 15px 0; }
        .comparison-table th, .comparison-table td { border: 1px solid #ddd; padding: 12px; text-align: left; }
        .comparison-table th { background-color: #f8f9fa; font-weight: bold; }
        .match { background-color: #d4edda !important; }
        .no-match { background-color: #f8d7da !important; }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîç Popular Items vs Menu Page Verification</h1>
        <p>This test verifies that all popular food items shown on the homepage are also visible on the menu page.</p>
        
        <div class="test-section">
            <h2>üéØ Test Results</h2>
            <div id="test-status" class="status info">Ready to test...</div>
            <button onclick="runVerificationTest()">üöÄ Run Verification Test</button>
            <button onclick="clearResults()">üóëÔ∏è Clear Results</button>
        </div>

        <div class="test-section">
            <h2>üìä Popular Items from Homepage API</h2>
            <div id="popular-items-display">Click "Run Verification Test" to load...</div>
        </div>

        <div class="test-section">
            <h2>üìã Menu Page Items by Category</h2>
            <div id="menu-items-display">Click "Run Verification Test" to load...</div>
        </div>

        <div class="test-section">
            <h2>üîç Item Matching Analysis</h2>
            <div id="matching-analysis">Click "Run Verification Test" to analyze...</div>
        </div>
    </div>

    <script>
        let popularItems = [];
        let menuItems = [];
        let categoryMatches = {};

        async function runVerificationTest() {
            updateStatus('üöÄ Starting verification test...', 'info');
            
            try {
                // Step 1: Load popular items (same as homepage)
                updateStatus('1Ô∏è‚É£ Loading popular items from homepage API...', 'info');
                const popularResponse = await fetch('/restuarent/api/menu.php?popular=true&limit=3');
                popularItems = await popularResponse.json();
                
                if (!Array.isArray(popularItems) || popularItems.length === 0) {
                    throw new Error('No popular items returned from API');
                }
                
                updateStatus(`‚úÖ Loaded ${popularItems.length} popular items`, 'success');
                displayPopularItems();

                // Step 2: Load all menu items
                updateStatus('2Ô∏è‚É£ Loading all menu items...', 'info');
                const menuResponse = await fetch('/restuarent/api/menu.php');
                menuItems = await menuResponse.json();
                
                if (!Array.isArray(menuItems) || menuItems.length === 0) {
                    throw new Error('No menu items returned from API');
                }
                
                updateStatus(`‚úÖ Loaded ${menuItems.length} total menu items`, 'success');
                
                // Step 3: Test category matching logic (same as menu.html)
                updateStatus('3Ô∏è‚É£ Testing category matching logic...', 'info');
                testCategoryMatching();
                displayMenuItems();

                // Step 4: Verify popular items appear in menu
                updateStatus('4Ô∏è‚É£ Verifying popular items appear in menu...', 'info');
                const verification = verifyPopularItemsInMenu();
                
                if (verification.allFound) {
                    updateStatus(`üéâ SUCCESS: All ${popularItems.length} popular items are correctly displayed on menu page!`, 'success');
                } else {
                    updateStatus(`‚ùå ISSUE: ${verification.missing.length} popular items are missing from menu page`, 'error');
                }
                
                displayMatchingAnalysis(verification);

            } catch (error) {
                updateStatus(`‚ùå ERROR: ${error.message}`, 'error');
                console.error('Verification test error:', error);
            }
        }

        function updateStatus(message, type) {
            const statusDiv = document.getElementById('test-status');
            statusDiv.textContent = message;
            statusDiv.className = `status ${type}`;
            console.log(message);
        }

        function displayPopularItems() {
            const div = document.getElementById('popular-items-display');
            div.innerHTML = `
                <p><strong>Popular Items (${popularItems.length}):</strong></p>
                ${popularItems.map((item, index) => `
                    <div class="item-card">
                        <h4>${index + 1}. ${item.name}</h4>
                        <p><strong>Category:</strong> "${item.category}"</p>
                        <p><strong>Price:</strong> Rs. ${item.price}</p>
                        <p><strong>ID:</strong> ${item.id}</p>
                        <img src="${item.image_url}" alt="${item.name}" 
                             onerror="this.src='images/popular/2.png'">
                    </div>
                `).join('')}
            `;
        }

        function testCategoryMatching() {
            // Use the exact same category matching logic as menu.html
            const categories = [
                { 
                    id: 'rice-curry', 
                    name: 'Rice & Curry', 
                    matches: ['rice & curry', 'rice&curry', 'ricecurry', 'rice', 'curry'] 
                },
                { 
                    id: 'chinese', 
                    name: 'Chinese', 
                    matches: ['chinese'] 
                },
                { 
                    id: 'seafood', 
                    name: 'Seafood', 
                    matches: ['seafood'] 
                },
                { 
                    id: 'kottu', 
                    name: 'Kottu', 
                    matches: ['kottu'] 
                },
                { 
                    id: 'juices', 
                    name: 'Juices', 
                    matches: ['juices', 'juice'] 
                },
                { 
                    id: 'desserts', 
                    name: 'Desserts', 
                    matches: ['desserts', 'dessert'] 
                },
                { 
                    id: 'others', 
                    name: 'Other Specialties', 
                    matches: ['pasta', 'salad', 'other', 'other specialties', 'specialties'] 
                }
            ];

            categoryMatches = {};

            categories.forEach(category => {
                const categoryItems = menuItems.filter(item => {
                    const itemCategory = item.category.toLowerCase().trim();
                    
                    // Check all possible matches for this category
                    return category.matches.some(match => {
                        return itemCategory === match || itemCategory.includes(match);
                    });
                });

                categoryMatches[category.id] = {
                    name: category.name,
                    items: categoryItems,
                    matches: category.matches
                };
            });
        }

        function displayMenuItems() {
            const div = document.getElementById('menu-items-display');
            let html = '';
            
            Object.entries(categoryMatches).forEach(([categoryId, categoryData]) => {
                html += `
                    <div style="margin: 20px 0; padding: 15px; border: 1px solid #ddd; border-radius: 5px;">
                        <h3>${categoryData.name} (${categoryData.items.length} items)</h3>
                        <p><small>Matches: [${categoryData.matches.join(', ')}]</small></p>
                        ${categoryData.items.length > 0 ? 
                            categoryData.items.map(item => `
                                <div style="background: #f8f9fa; margin: 5px 0; padding: 8px; border-radius: 3px;">
                                    <strong>${item.name}</strong> (ID: ${item.id}) - Category: "${item.category}" - Rs. ${item.price}
                                </div>
                            `).join('') :
                            '<p style="color: #666; font-style: italic;">No items found in this category</p>'
                        }
                    </div>
                `;
            });
            
            div.innerHTML = html;
        }

        function verifyPopularItemsInMenu() {
            const allMenuItemsFlat = Object.values(categoryMatches).flatMap(cat => cat.items);
            const menuItemIds = new Set(allMenuItemsFlat.map(item => item.id));
            
            const found = [];
            const missing = [];
            
            popularItems.forEach(popularItem => {
                if (menuItemIds.has(popularItem.id)) {
                    found.push(popularItem);
                } else {
                    missing.push(popularItem);
                }
            });
            
            return {
                allFound: missing.length === 0,
                found: found,
                missing: missing,
                totalPopular: popularItems.length,
                foundCount: found.length
            };
        }

        function displayMatchingAnalysis(verification) {
            const div = document.getElementById('matching-analysis');
            
            let html = `
                <table class="comparison-table">
                    <thead>
                        <tr>
                            <th>Popular Item</th>
                            <th>Category</th>
                            <th>ID</th>
                            <th>Status</th>
                            <th>Found In Menu?</th>
                        </tr>
                    </thead>
                    <tbody>
            `;
            
            popularItems.forEach(item => {
                const isFound = verification.found.some(f => f.id === item.id);
                const statusClass = isFound ? 'match' : 'no-match';
                const statusText = isFound ? '‚úÖ FOUND' : '‚ùå MISSING';
                
                html += `
                    <tr class="${statusClass}">
                        <td><strong>${item.name}</strong></td>
                        <td>"${item.category}"</td>
                        <td>${item.id}</td>
                        <td>${statusText}</td>
                        <td>${isFound ? 'Yes - appears in menu page' : 'No - missing from menu page'}</td>
                    </tr>
                `;
            });
            
            html += `
                    </tbody>
                </table>
                <div style="margin-top: 15px;">
                    <h4>Summary:</h4>
                    <p><strong>Total Popular Items:</strong> ${verification.totalPopular}</p>
                    <p><strong>Found in Menu:</strong> ${verification.foundCount}</p>
                    <p><strong>Missing from Menu:</strong> ${verification.missing.length}</p>
                    <p><strong>Success Rate:</strong> ${Math.round((verification.foundCount / verification.totalPopular) * 100)}%</p>
                </div>
            `;
            
            if (verification.missing.length > 0) {
                html += `
                    <div style="margin-top: 15px; padding: 10px; background: #f8d7da; border-radius: 5px;">
                        <h4 style="color: #721c24;">Missing Items Analysis:</h4>
                        ${verification.missing.map(item => `
                            <p><strong>${item.name}</strong> (Category: "${item.category}") is not appearing on the menu page. This suggests the category matching logic may need adjustment.</p>
                        `).join('')}
                    </div>
                `;
            }
            
            div.innerHTML = html;
        }

        function clearResults() {
            document.getElementById('test-status').textContent = 'Ready to test...';
            document.getElementById('test-status').className = 'status info';
            document.getElementById('popular-items-display').textContent = 'Click "Run Verification Test" to load...';
            document.getElementById('menu-items-display').textContent = 'Click "Run Verification Test" to load...';
            document.getElementById('matching-analysis').textContent = 'Click "Run Verification Test" to analyze...';
            popularItems = [];
            menuItems = [];
            categoryMatches = {};
        }
    </script>
</body>
</html>
