<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cart Image Issue - Final Verification</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            padding: 20px;
            background: #f5f5f5;
        }
        .test-container {
            background: white;
            margin: 20px 0;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .status {
            padding: 15px;
            margin: 10px 0;
            border-radius: 5px;
            font-weight: bold;
        }
        .success { background: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .error { background: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
        .warning { background: #fff3cd; color: #856404; border: 1px solid #ffeaa7; }
        .info { background: #d1ecf1; color: #0c5460; border: 1px solid #bee5eb; }
        
        .btn {
            background: #007bff;
            color: white;
            border: none;
            padding: 12px 24px;
            margin: 5px;
            border-radius: 5px;
            cursor: pointer;
            font-weight: bold;
        }
        .btn:hover { background: #0056b3; }
        .btn-danger { background: #dc3545; }
        .btn-danger:hover { background: #c82333; }
        .btn-success { background: #28a745; }
        .btn-success:hover { background: #218838; }
        
        .item-display {
            border: 2px solid #ddd;
            border-radius: 10px;
            padding: 20px;
            margin: 15px 0;
            background: white;
            display: flex;
            align-items: center;
            gap: 20px;
        }
        .item-display img {
            width: 120px;
            height: 120px;
            object-fit: cover;
            border-radius: 8px;
        }
        .item-info {
            flex: 1;
        }
        
        .code-block {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 5px;
            font-family: 'Courier New', monospace;
            font-size: 14px;
            border-left: 4px solid #007bff;
            margin: 10px 0;
            white-space: pre-wrap;
        }
        
        .order-simulation {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            padding: 20px;
            margin: 15px 0;
        }
        
        h1 { color: #333; text-align: center; }
        h2 { color: #555; border-bottom: 2px solid #ddd; padding-bottom: 10px; }
    </style>
</head>
<body>
    <h1>üõí Cart Image Issue - Final Verification</h1>
    
    <div class="test-container">
        <h2>üîç Current Problem Analysis</h2>
        <div class="info">
            <strong>Issue:</strong> Newly uploaded menu items show correct images on menu page but display wrong fallback images in order page cart section.
        </div>
        <button class="btn" onclick="analyzeProblem()">üîç Analyze Current Problem</button>
        <div id="problem-analysis"></div>
    </div>

    <div class="test-container">
        <h2>üß™ Live Cart Testing</h2>
        <p>Test adding items to cart and checking if image URLs are preserved:</p>
        
        <button class="btn btn-danger" onclick="clearCart()">üóëÔ∏è Clear Cart First</button>
        <button class="btn btn-success" onclick="testUploadedItem()">‚ûï Add Uploaded Item</button>
        <button class="btn btn-success" onclick="testPopularItem()">‚ûï Add Popular Item</button>
        <button class="btn" onclick="simulateOrderPage()">üìã Simulate Order Page Display</button>
        
        <div id="cart-test-results"></div>
    </div>

    <div class="test-container">
        <h2>üîç Menu Button Analysis</h2>
        <p>Let's check how the menu buttons are calling the cart function:</p>
        <button class="btn" onclick="analyzeMenuButtons()">üîç Analyze Menu Button Code</button>
        <div id="menu-button-analysis"></div>
    </div>

    <div class="test-container">
        <h2>üìù Function Code Verification</h2>
        <button class="btn" onclick="verifyFunctions()">üîç Verify Cart Functions</button>
        <div id="function-verification"></div>
    </div>

    <div class="test-container">
        <h2>üöÄ Live Test: Open Order Page</h2>
        <p>After adding items above, click this button to open the order page and manually verify:</p>
        <button class="btn btn-success" onclick="openOrderPage()">üöÄ Open Order Page in New Tab</button>
        <div class="warning">
            <strong>Manual Check Required:</strong><br>
            1. Look at the "üõí Your Items" section in the order page<br>
            2. Check if uploaded items show their correct image URLs<br>
            3. Verify that the paths match what was displayed on the menu page
        </div>
    </div>

    <script src="js/script.js"></script>
    <script>
        function analyzeProblem() {
            const analysisDiv = document.getElementById('problem-analysis');
            
            // Check if the functions exist
            let html = '<h4>üîß Function Availability Check:</h4>';
            
            const functions = [
                'addToCartWithQuantity',
                'displayOrderItems',
                'updateCartItemImages',
                'initializeCart'
            ];
            
            functions.forEach(func => {
                if (typeof window[func] === 'function') {
                    html += `<div class="success">‚úÖ ${func}() - Available</div>`;
                } else {
                    html += `<div class="error">‚ùå ${func}() - Missing</div>`;
                }
            });
            
            // Check current cart state
            const cart = JSON.parse(localStorage.getItem('restaurant_cart') || '[]');
            html += `<h4>üìä Current Cart State:</h4>`;
            html += `<div class="info">Cart has ${cart.length} items</div>`;
            
            if (cart.length > 0) {
                cart.forEach((item, index) => {
                    html += `<div class="code-block">Item ${index + 1}: ${item.name}
Image URL: ${item.image_url || 'NOT SET'}
ID: ${item.id} | Price: Rs. ${item.price} | Qty: ${item.quantity}</div>`;
                });
            }
            
            analysisDiv.innerHTML = html;
        }
        
        function testUploadedItem() {
            if (typeof addToCartWithQuantity !== 'function') {
                showResult('error', '‚ùå addToCartWithQuantity function not available');
                return;
            }
            
            // Simulate an uploaded menu item
            const uploadedImageUrl = 'http://localhost:8888/restuarent/uploads/menu-items/menu_item_6845639b70c75_1749377947.jpg';
            
            console.log('Testing uploaded item with URL:', uploadedImageUrl);
            
            addToCartWithQuantity(999, 'Test Uploaded Curry', 1200, uploadedImageUrl);
            
            setTimeout(() => {
                const cart = JSON.parse(localStorage.getItem('restaurant_cart') || '[]');
                const addedItem = cart.find(item => item.id === 999);
                
                if (addedItem) {
                    showResult('success', `‚úÖ Added uploaded item. Image URL stored: ${addedItem.image_url}`);
                } else {
                    showResult('error', '‚ùå Failed to add uploaded item to cart');
                }
            }, 100);
        }
        
        function testPopularItem() {
            if (typeof addToCartWithQuantity !== 'function') {
                showResult('error', '‚ùå addToCartWithQuantity function not available');
                return;
            }
            
            console.log('Testing popular item with fallback URL');
            
            addToCartWithQuantity(998, 'Popular Kottu Roti', 750, 'images/popular/2.png');
            
            setTimeout(() => {
                const cart = JSON.parse(localStorage.getItem('restaurant_cart') || '[]');
                const addedItem = cart.find(item => item.id === 998);
                
                if (addedItem) {
                    showResult('success', `‚úÖ Added popular item. Image URL stored: ${addedItem.image_url}`);
                } else {
                    showResult('error', '‚ùå Failed to add popular item to cart');
                }
            }, 100);
        }
        
        function simulateOrderPage() {
            const cart = JSON.parse(localStorage.getItem('restaurant_cart') || '[]');
            
            if (cart.length === 0) {
                showResult('warning', '‚ö†Ô∏è Cart is empty. Add some items first.');
                return;
            }
            
            if (typeof displayOrderItems !== 'function') {
                showResult('error', '‚ùå displayOrderItems function not available');
                return;
            }
            
            // Create a mock order items container
            const mockContainer = document.createElement('div');
            mockContainer.id = 'order-items-container';
            document.body.appendChild(mockContainer);
            
            // Call the actual displayOrderItems function
            displayOrderItems();
            
            // Get the generated HTML
            const generatedHTML = mockContainer.innerHTML;
            
            // Clean up
            document.body.removeChild(mockContainer);
            
            // Display results
            const resultsDiv = document.getElementById('cart-test-results');
            resultsDiv.innerHTML = `
                <h4>üñºÔ∏è Order Page Simulation Results:</h4>
                <div class="order-simulation">
                    <h5>Generated HTML for Order Items:</h5>
                    <div class="code-block">${generatedHTML.replace(/</g, '&lt;').replace(/>/g, '&gt;')}</div>
                </div>
                <div class="info">
                    <strong>Analysis:</strong><br>
                    ‚Ä¢ Check the img src attributes in the generated HTML above<br>
                    ‚Ä¢ Look for 'uploads/menu-items/' paths vs 'images/popular/' paths<br>
                    ‚Ä¢ Verify that onerror fallbacks are in place
                </div>
            `;
        }
        
        function analyzeMenuButtons() {
            const analysisDiv = document.getElementById('menu-button-analysis');
            
            let html = '<h4>üîç Menu Button Function Call Analysis:</h4>';
            
            // Show the expected pattern
            html += `<div class="info">
                <strong>Expected Menu Button Pattern:</strong><br>
                The menu.html should call buttons like this:
            </div>`;
            
            html += `<div class="code-block">onclick="addToCartWithQuantity(\${item.id}, '\${item.name}', \${item.price}, '\${item.image_url || 'images/popular/2.png'}')"</div>`;
            
            // Check the actual addToCartWithQuantity function signature
            if (typeof addToCartWithQuantity === 'function') {
                const funcString = addToCartWithQuantity.toString();
                const paramMatch = funcString.match(/function\s+addToCartWithQuantity\s*\(([^)]*)\)/);
                
                if (paramMatch) {
                    html += `<div class="success">‚úÖ Function signature: addToCartWithQuantity(${paramMatch[1]})</div>`;
                    
                    if (paramMatch[1].includes('imageUrl')) {
                        html += `<div class="success">‚úÖ imageUrl parameter is present</div>`;
                    } else {
                        html += `<div class="error">‚ùå imageUrl parameter is missing</div>`;
                    }
                }
            }
            
            // Test the actual function call
            html += `<div class="info">
                <strong>Testing Function Call:</strong><br>
                Let's test if the function properly stores the image URL...
            </div>`;
            
            analysisDiv.innerHTML = html;
        }
        
        function verifyFunctions() {
            const verificationDiv = document.getElementById('function-verification');
            
            let html = '<h4>üìù Function Code Verification:</h4>';
            
            // Check addToCartWithQuantity function
            if (typeof addToCartWithQuantity === 'function') {
                const funcCode = addToCartWithQuantity.toString();
                
                html += `<div class="success">‚úÖ addToCartWithQuantity function exists</div>`;
                
                if (funcCode.includes('image_url: imageUrl')) {
                    html += `<div class="success">‚úÖ Function stores image_url property</div>`;
                } else {
                    html += `<div class="error">‚ùå Function doesn't store image_url property</div>`;
                }
                
                if (funcCode.includes("'images/popular/3.png'")) {
                    html += `<div class="success">‚úÖ Function has fallback image</div>`;
                } else {
                    html += `<div class="warning">‚ö†Ô∏è Function fallback image might be different</div>`;
                }
            }
            
            // Check displayOrderItems function
            if (typeof displayOrderItems === 'function') {
                const funcCode = displayOrderItems.toString();
                
                html += `<div class="success">‚úÖ displayOrderItems function exists</div>`;
                
                if (funcCode.includes('item.image_url')) {
                    html += `<div class="success">‚úÖ Function uses item.image_url</div>`;
                } else {
                    html += `<div class="error">‚ùå Function doesn't use item.image_url</div>`;
                }
                
                if (funcCode.includes('onerror')) {
                    html += `<div class="success">‚úÖ Function has image error handling</div>`;
                } else {
                    html += `<div class="warning">‚ö†Ô∏è Function might not have image error handling</div>`;
                }
            }
            
            verificationDiv.innerHTML = html;
        }
        
        function clearCart() {
            if (typeof clearCart === 'function') {
                window.clearCart();
            } else {
                localStorage.removeItem('restaurant_cart');
                if (typeof window.cart !== 'undefined') {
                    window.cart = [];
                }
            }
            showResult('success', '‚úÖ Cart cleared');
        }
        
        function openOrderPage() {
            const cart = JSON.parse(localStorage.getItem('restaurant_cart') || '[]');
            
            if (cart.length === 0) {
                alert('‚ö†Ô∏è Cart is empty! Add some test items first.');
                return;
            }
            
            showResult('info', 'üöÄ Opening order page in new tab. Check the "üõí Your Items" section manually.');
            
            setTimeout(() => {
                window.open('order.html', '_blank');
            }, 1000);
        }
        
        function showResult(type, message) {
            const resultDiv = document.createElement('div');
            resultDiv.className = `status ${type}`;
            resultDiv.textContent = message;
            
            // Find the last container that was used
            const containers = document.querySelectorAll('.test-container');
            const lastContainer = containers[containers.length - 1];
            lastContainer.appendChild(resultDiv);
            
            // Remove after 5 seconds
            setTimeout(() => {
                if (resultDiv.parentNode) {
                    resultDiv.remove();
                }
            }, 5000);
        }
        
        // Auto-run problem analysis when page loads
        document.addEventListener('DOMContentLoaded', function() {
            setTimeout(analyzeProblem, 500);
        });
    </script>
</body>
</html>
