<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Real-Time Rice & Curry Debug</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .section { margin: 20px 0; padding: 15px; border: 2px solid #ddd; border-radius: 8px; }
        .log { background: #f8f9fa; padding: 10px; margin: 5px 0; border-radius: 4px; border-left: 4px solid #007bff; }
        .error { border-left-color: #dc3545; background: #f8d7da; }
        .success { border-left-color: #28a745; background: #d4edda; }
        .warning { border-left-color: #ffc107; background: #fff3cd; }
        button { background: #007bff; color: white; border: none; padding: 10px 20px; margin: 5px; border-radius: 5px; cursor: pointer; }
        pre { background: #f8f9fa; padding: 10px; border-radius: 4px; overflow-x: auto; font-size: 12px; }
    </style>
</head>
<body>
    <h1>üîß Real-Time Rice & Curry Debug</h1>
    
    <div class="section">
        <h2>Live Menu Monitoring</h2>
        <button onclick="startMonitoring()">üì° Start Monitoring</button>
        <button onclick="stopMonitoring()">‚èπÔ∏è Stop Monitoring</button>
        <button onclick="clearLogs()">üóëÔ∏è Clear Logs</button>
        <div id="monitoring-status"></div>
        <div id="live-logs"></div>
    </div>

    <div class="section">
        <h2>Current Rice & Curry Display</h2>
        <div id="current-display"></div>
    </div>

    <script>
        let monitoringInterval;
        let logs = [];
        let previousItemCount = null;

        function addLog(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            logs.push({ timestamp, message, type });
            updateLogs();
        }

        function updateLogs() {
            const logsDiv = document.getElementById('live-logs');
            logsDiv.innerHTML = logs.slice(-20).reverse().map(log => 
                `<div class="log ${log.type}">[${log.timestamp}] ${log.message}</div>`
            ).join('');
        }

        function clearLogs() {
            logs = [];
            updateLogs();
        }

        async function checkRiceCurryItems() {
            try {
                const response = await fetch('api/menu.php', { 
                    cache: 'no-cache',
                    headers: {
                        'Cache-Control': 'no-cache',
                        'Pragma': 'no-cache'
                    }
                });
                const allItems = await response.json();
                
                // Apply exact filtering logic from menu.html
                const riceCurryMatches = ['rice & curry', 'rice&curry', 'ricecurry', 'rice', 'curry'];
                const riceCurryItems = allItems.filter(item => {
                    const itemCategory = item.category.toLowerCase().trim();
                    return riceCurryMatches.some(match => {
                        return itemCategory === match || itemCategory.includes(match);
                    });
                });

                const currentCount = riceCurryItems.length;
                const itemIds = riceCurryItems.map(item => item.id).sort();

                // Check for changes
                if (previousItemCount !== null && previousItemCount !== currentCount) {
                    addLog(`‚ö†Ô∏è ITEM COUNT CHANGED: ${previousItemCount} ‚Üí ${currentCount}`, 'warning');
                }

                if (currentCount === 0) {
                    addLog(`‚ùå NO RICE & CURRY ITEMS FOUND!`, 'error');
                } else if (currentCount !== 5) {
                    addLog(`‚ö†Ô∏è Expected 5 items, found ${currentCount} (IDs: ${itemIds.join(', ')})`, 'warning');
                } else {
                    addLog(`‚úÖ Found ${currentCount} Rice & Curry items (IDs: ${itemIds.join(', ')})`, 'success');
                }

                previousItemCount = currentCount;

                // Update display
                const displayDiv = document.getElementById('current-display');
                if (riceCurryItems.length > 0) {
                    displayDiv.innerHTML = `
                        <h3>Current Rice & Curry Items (${riceCurryItems.length})</h3>
                        ${riceCurryItems.map(item => `
                            <div style="border: 1px solid #ddd; margin: 5px; padding: 10px; border-radius: 4px;">
                                <strong>${item.name}</strong> - Rs. ${item.price}<br>
                                <small>ID: ${item.id}, Category: "${item.category}"</small>
                            </div>
                        `).join('')}
                    `;
                } else {
                    displayDiv.innerHTML = '<div style="color: red; padding: 20px; text-align: center;">‚ùå No Rice & Curry items found!</div>';
                }

                return { count: currentCount, items: riceCurryItems, allItemsCount: allItems.length };

            } catch (error) {
                addLog(`‚ùå API Error: ${error.message}`, 'error');
                return { count: 0, items: [], error: error.message };
            }
        }

        function startMonitoring() {
            if (monitoringInterval) {
                clearInterval(monitoringInterval);
            }

            addLog('üîÑ Starting live monitoring...', 'info');
            document.getElementById('monitoring-status').innerHTML = '<span style="color: green;">‚óè MONITORING ACTIVE</span>';

            // Initial check
            checkRiceCurryItems();

            // Check every 2 seconds
            monitoringInterval = setInterval(checkRiceCurryItems, 2000);
        }

        function stopMonitoring() {
            if (monitoringInterval) {
                clearInterval(monitoringInterval);
                monitoringInterval = null;
                addLog('‚èπÔ∏è Monitoring stopped', 'info');
                document.getElementById('monitoring-status').innerHTML = '<span style="color: red;">‚óè MONITORING STOPPED</span>';
            }
        }

        // Test the exact reload functionality from menu.html
        async function testReloadFunction() {
            addLog('üîÑ Testing reload function...', 'info');
            
            try {
                // Clear display
                document.getElementById('current-display').innerHTML = '<p style="text-align: center; color: #666;">Reloading...</p>';
                
                // Wait to simulate reload button behavior
                await new Promise(resolve => setTimeout(resolve, 100));
                
                // Call the check function
                const result = await checkRiceCurryItems();
                
                addLog(`‚úÖ Reload test completed: ${result.count} items found`, 'success');
                
            } catch (error) {
                addLog(`‚ùå Reload test failed: ${error.message}`, 'error');
            }
        }

        // Add reload test button
        document.addEventListener('DOMContentLoaded', function() {
            const firstSection = document.querySelector('.section');
            const reloadButton = document.createElement('button');
            reloadButton.onclick = testReloadFunction;
            reloadButton.innerHTML = 'üîÑ Test Reload Function';
            reloadButton.style.backgroundColor = '#28a745';
            firstSection.appendChild(reloadButton);
            
            // Auto-start monitoring
            setTimeout(() => {
                addLog('üöÄ Auto-starting monitoring...', 'info');
                startMonitoring();
            }, 1000);
        });
    </script>
</body>
</html>
