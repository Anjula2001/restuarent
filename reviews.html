<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Customer Reviews - Grand Restaurant</title>
    <link rel="stylesheet" href="css/style.css">
    <style>
        .reviews-section {
            padding: 50px 20px;
            background-color: #f8f9fa;
            min-height: calc(100vh - 200px);
        }

        .reviews-header {
            text-align: center;
            margin-bottom: 50px;
            max-width: 800px;
            margin-left: auto;
            margin-right: auto;
        }

        .reviews-header h1 {
            font-size: 3em;
            color: #333;
            margin-bottom: 20px;
            font-weight: bold;
        }

        .reviews-header p {
            font-size: 1.2em;
            color: #666;
            line-height: 1.6;
        }

        .reviews-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            max-width: 800px;
            margin: 0 auto 50px auto;
        }

        .stat-card {
            background: white;
            padding: 30px;
            border-radius: 12px;
            text-align: center;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
            border: 1px solid #e9ecef;
        }

        .stat-number {
            font-size: 3em;
            font-weight: bold;
            color: #8B5A2B;
            margin-bottom: 10px;
        }

        .stat-label {
            color: #666;
            font-size: 1.1em;
        }

        .reviews-container {
            max-width: 1200px;
            margin: 0 auto;
        }

        .reviews-filters {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin-bottom: 40px;
            flex-wrap: wrap;
        }

        .filter-btn {
            background: white;
            border: 2px solid #8B5A2B;
            color: #8B5A2B;
            padding: 10px 20px;
            border-radius: 25px;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s;
        }

        .filter-btn:hover,
        .filter-btn.active {
            background: #8B5A2B;
            color: white;
        }

        .reviews-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
            gap: 30px;
            margin-bottom: 50px;
        }

        .review-card {
            background: white;
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 6px 20px rgba(0,0,0,0.1);
            border: 1px solid #f0f0f0;
            transition: transform 0.3s, box-shadow 0.3s;
            position: relative;
            overflow: hidden;
        }

        .review-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 30px rgba(0,0,0,0.15);
        }

        .review-header {
            display: flex;
            align-items: center;
            margin-bottom: 20px;
        }

        .reviewer-avatar {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: linear-gradient(135deg, #8B5A2B, #D2B48C);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 1.5em;
            font-weight: bold;
            margin-right: 15px;
        }

        .reviewer-info h3 {
            margin: 0;
            color: #333;
            font-size: 1.2em;
        }

        .review-date {
            color: #888;
            font-size: 0.9em;
            margin: 5px 0;
        }

        .review-rating {
            display: flex;
            gap: 2px;
            margin-bottom: 20px;
        }

        .star {
            color: #ffd700;
            font-size: 1.3em;
        }

        .star.empty {
            color: #ddd;
        }

        .review-text {
            color: #555;
            line-height: 1.7;
            font-size: 1.05em;
            margin-bottom: 20px;
            position: relative;
        }

        .review-text::before {
            content: "\201C";
            font-size: 3em;
            color: #8B5A2B;
            opacity: 0.3;
            position: absolute;
            top: 10px;
            left: 15px;
            font-family: serif;
        }

        .review-text::after {
            content: "\201D";
            font-size: 3em;
            color: #8B5A2B;
            opacity: 0.3;
            position: absolute;
            bottom: 10px;
            right: 15px;
            font-family: serif;
        }

        .review-helpful {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding-top: 15px;
            border-top: 1px solid #f0f0f0;
        }

        .helpful-btn {
            background: none;
            border: 1px solid #ddd;
            color: #666;
            padding: 8px 15px;
            border-radius: 20px;
            cursor: pointer;
            font-size: 0.9em;
            transition: all 0.3s;
        }

        .helpful-btn:hover {
            background: #8B5A2B;
            color: white;
            border-color: #8B5A2B;
        }

        .loading {
            text-align: center;
            padding: 50px;
            color: #666;
            font-size: 1.2em;
        }

        .no-reviews {
            text-align: center;
            padding: 100px 20px;
            color: #999;
        }

        .no-reviews h3 {
            font-size: 2em;
            margin-bottom: 20px;
        }

        .no-reviews p {
            font-size: 1.1em;
            margin-bottom: 30px;
        }

        .write-review-btn {
            background: #8B5A2B;
            color: white;
            padding: 15px 30px;
            border: none;
            border-radius: 25px;
            font-size: 1.1em;
            cursor: pointer;
            text-decoration: none;
            display: inline-block;
            transition: background 0.3s;
        }

        .write-review-btn:hover {
            background: #654321;
        }

        .pagination {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin-top: 50px;
        }

        .page-btn {
            background: white;
            border: 2px solid #8B5A2B;
            color: #8B5A2B;
            padding: 10px 15px;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .page-btn:hover,
        .page-btn.active {
            background: #8B5A2B;
            color: white;
        }

        .page-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        /* Review Submission Form Styles */
        .review-submission {
            background: white;
            border-radius: 15px;
            padding: 40px;
            margin: 50px auto;
            box-shadow: 0 6px 20px rgba(0,0,0,0.1);
            border: 1px solid #f0f0f0;
            max-width: 600px;
        }

        .review-submission h3 {
            text-align: center;
            color: #333;
            margin-bottom: 30px;
            font-size: 1.8em;
        }

        .form-group {
            margin-bottom: 25px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            color: #555;
            font-weight: bold;
        }

        .form-group input,
        .form-group textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            font-size: 1em;
            transition: border-color 0.3s;
            box-sizing: border-box;
        }

        .form-group input:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: #8B5A2B;
        }

        .form-group textarea {
            resize: vertical;
            min-height: 120px;
        }

        /* Star Rating Widget */
        .star-rating {
            margin: 20px 0;
            text-align: center;
        }

        .star-rating label {
            display: block;
            margin-bottom: 15px;
            font-weight: bold;
            color: #555;
            font-size: 1.1em;
        }

        .stars-container {
            display: flex;
            justify-content: center;
            gap: 5px;
            margin-bottom: 10px;
        }

        .star-input {
            display: none;
        }

        .star-label {
            font-size: 2.5em;
            color: #ddd;
            cursor: pointer;
            transition: all 0.2s ease;
            user-select: none;
        }

        .star-label:hover,
        .star-input:checked ~ .star-label,
        .star-label.active {
            color: #ffd700;
            transform: scale(1.1);
        }

        .star-label:hover ~ .star-label {
            color: #ddd;
            transform: scale(1);
        }

        .rating-text {
            text-align: center;
            margin-top: 10px;
            font-size: 1.1em;
            color: #666;
            min-height: 25px;
        }

        .submit-review-btn {
            background: linear-gradient(135deg, #8B5A2B, #A0522D);
            color: white;
            padding: 15px 40px;
            border: none;
            border-radius: 25px;
            font-size: 1.1em;
            cursor: pointer;
            display: block;
            margin: 30px auto 0;
            transition: all 0.3s;
            font-weight: bold;
        }

        .submit-review-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(139, 90, 43, 0.3);
        }

        .submit-review-btn:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .form-message {
            text-align: center;
            padding: 15px;
            border-radius: 8px;
            margin-top: 20px;
            display: none;
        }

        .form-message.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .form-message.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        /* Popup Modal Styles */
        .popup-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            animation: fadeIn 0.3s ease-in-out;
        }

        .popup-modal {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
            max-width: 400px;
            width: 90%;
            text-align: center;
            animation: slideIn 0.3s ease-in-out;
        }

        .popup-icon {
            font-size: 4em;
            margin-bottom: 15px;
        }

        .popup-icon.success {
            color: #28a745;
        }

        .popup-icon.error {
            color: #dc3545;
        }

        .popup-title {
            font-size: 1.4em;
            font-weight: bold;
            margin-bottom: 10px;
            color: #333;
        }

        .popup-message {
            font-size: 1em;
            color: #666;
            line-height: 1.5;
            margin-bottom: 25px;
        }

        .popup-button {
            background: #8B5A2B;
            color: white;
            padding: 12px 30px;
            border: none;
            border-radius: 25px;
            font-size: 1em;
            cursor: pointer;
            transition: background 0.3s;
        }

        .popup-button:hover {
            background: #7A4F26;
        }

        .popup-button.error {
            background: #dc3545;
        }

        .popup-button.error:hover {
            background: #c82333;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        @keyframes slideIn {
            from { 
                opacity: 0;
                transform: translate(-50%, -60%);
            }
            to { 
                opacity: 1;
                transform: translate(-50%, -50%);
            }
        }

        /* Toggle Review Form */
        .write-review-toggle {
            text-align: center;
            margin: 40px 0;
        }

        .toggle-form-btn {
            background: #8B5A2B;
            color: white;
            padding: 15px 30px;
            border: none;
            border-radius: 25px;
            font-size: 1.1em;
            cursor: pointer;
            transition: background 0.3s;
            font-weight: bold;
        }

        .toggle-form-btn:hover {
            background: #654321;
        }

        @media (max-width: 768px) {
            .reviews-header h1 {
                font-size: 2.5em;
            }

            .reviews-grid {
                grid-template-columns: 1fr;
                gap: 20px;
            }

            .review-card {
                padding: 20px;
            }

            .stat-card {
                padding: 20px;
            }

            .stat-number {
                font-size: 2.5em;
            }

            .review-submission {
                margin: 30px 20px;
                padding: 30px 20px;
            }

            .star-label {
                font-size: 2em;
            }

            .stars-container {
                gap: 2px;
            }
        }

        /* Animation classes */
        .fade-in {
            opacity: 0;
            animation: fadeIn 0.6s forwards;
        }

        @keyframes fadeIn {
            to {
                opacity: 1;
            }
        }

        .slide-up {
            transform: translateY(30px);
            opacity: 0;
            animation: slideUp 0.6s forwards;
        }

        @keyframes slideUp {
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        /* Animation for form appearance */
        .review-submission.show {
            animation: slideIn 0.5s ease-out;
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(-20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* Enhanced Error Card Styles for Reviews Page */
        .error-card {
            background: linear-gradient(135deg, #fff 0%, #f8f9fa 100%);
            border-radius: 15px;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
            margin: 30px auto;
            max-width: 600px;
            overflow: hidden;
            border: 1px solid #e9ecef;
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }

        .error-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 12px 35px rgba(0, 0, 0, 0.15);
        }

        .error-card-content {
            padding: 40px 30px;
            text-align: center;
        }

        .error-icon {
            margin-bottom: 25px;
        }

        .error-icon-circle {
            display: inline-block;
            width: 80px;
            height: 80px;
            background: linear-gradient(135deg, #ffeaa7 0%, #fdcb6e 100%);
            border-radius: 50%;
            line-height: 80px;
            font-size: 36px;
            box-shadow: 0 4px 15px rgba(253, 203, 110, 0.3);
            animation: pulse-warning 2s infinite;
        }

        @keyframes pulse-warning {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }

        .error-details {
            margin-bottom: 30px;
        }

        .error-title {
            color: #2d3436;
            font-size: 24px;
            font-weight: 600;
            margin: 0 0 15px 0;
            letter-spacing: -0.5px;
        }

        .error-message {
            color: #636e72;
            font-size: 16px;
            line-height: 1.6;
            margin: 0 0 25px 0;
            max-width: 500px;
            margin-left: auto;
            margin-right: auto;
        }

        .error-suggestions {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 20px;
            margin: 20px 0;
            text-align: left;
            max-width: 400px;
            margin-left: auto;
            margin-right: auto;
            border-left: 4px solid #8B5A2B;
        }

        .suggestion-title {
            font-weight: 600;
            color: #2d3436;
            margin: 0 0 12px 0;
            font-size: 14px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .suggestion-list {
            margin: 0;
            padding-left: 20px;
            color: #636e72;
        }

        .suggestion-list li {
            margin-bottom: 8px;
            font-size: 14px;
            line-height: 1.4;
        }

        .error-actions {
            display: flex;
            gap: 15px;
            justify-content: center;
            flex-wrap: wrap;
        }

        .retry-btn {
            background: linear-gradient(135deg, #8B5A2B 0%, #A0522D 100%);
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 50px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(139, 90, 43, 0.3);
            display: flex;
            align-items: center;
            gap: 8px;
            text-decoration: none;
        }

        .retry-btn:hover {
            background: linear-gradient(135deg, #654321 0%, #8B4513 100%);
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(139, 90, 43, 0.4);
        }

        .secondary-btn {
            background: linear-gradient(135deg, #74b9ff 0%, #0984e3 100%);
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 50px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(116, 185, 255, 0.3);
            display: flex;
            align-items: center;
            gap: 8px;
            text-decoration: none;
        }

        .secondary-btn:hover {
            background: linear-gradient(135deg, #5498ff 0%, #2d3436 100%);
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(116, 185, 255, 0.4);
        }

        .btn-icon {
            font-size: 14px;
            animation: rotate 2s linear infinite;
        }

        @keyframes rotate {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }

        .retry-btn:hover .btn-icon {
            animation-duration: 0.5s;
        }

        /* Responsive design for error card */
        @media (max-width: 768px) {
            .error-card-content {
                padding: 30px 20px;
            }
            
            .error-title {
                font-size: 20px;
            }
            
            .error-message {
                font-size: 14px;
            }
            
            .error-actions {
                flex-direction: column;
                align-items: center;
            }
            
            .retry-btn, .secondary-btn {
                width: 100%;
                max-width: 250px;
                justify-content: center;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Header Section -->
        <header>
            <div class="logo">
                <a href="index.html">
                    <h1>GRAND</h1>
                    <p>RESTAURANT</p>
                </a>
            </div>
            <div class="header-right">
                <div class="search-bar">
                    <input type="text" placeholder="Search Food">
                </div>
                <div class="cart-icon" id="cart-toggle">
                    <span>🛒</span>
                    <span class="cart-count" id="cart-count">0</span>
                </div>
                <!-- Authentication Buttons -->
                <div class="auth-buttons" id="authButtons">
                    <div id="guestLinks" style="display: inline;">
                        <a href="login.html" class="auth-btn login">LOGIN</a>
                        <a href="register.html" class="auth-btn register">REGISTER</a>
                    </div>
                    <div id="userLinks" style="display: none;">
                        <a href="dashboard.html" class="auth-btn dashboard">DASHBOARD</a>
                        <a href="profile.html" class="auth-btn profile">PROFILE</a>
                        <a href="#" onclick="logout()" class="auth-btn logout">LOGOUT</a>
                    </div>
                </div>
            </div>
        </header>

        <!-- Navigation Menu -->
        <nav>
            <ul class="main-menu">
                <li><a href="index.html">HOME</a></li>
                <li><a href="menu.html">MENU</a></li>
                <li><a href="reservation.html">RESERVATION</a></li>
                <li><a href="order.html">ORDER ONLINE</a></li>
                <li><a href="contact.html">CONTACT</a></li>
                <li><a href="reviews.html" class="active">REVIEWS</a></li>
            </ul>
        </nav>

        <!-- Hero Section -->
        <section class="hero">
            <h2>What Our Customers Say</h2>
            <h3>Real Reviews from Real Customers</h3>
        </section>

        <!-- Reviews Section -->
        <section class="reviews-section">
            <div class="reviews-header fade-in">
                <h1>Customer Reviews</h1>
                <p>
                    Discover what our valued customers are saying about their dining experiences at Grand Restaurant. 
                    Every review helps us continue to deliver exceptional Sri Lankan cuisine and outstanding service.
                </p>
            </div>

            <!-- Toggle Review Form Button -->
            <div class="write-review-toggle">
                <button class="toggle-form-btn" id="toggleReviewForm">✏️ Write a Review</button>
            </div>

            <!-- Review Submission Form (initially hidden) -->
            <div class="review-submission" id="reviewSubmissionForm" style="display: none;">
                <h3>Submit Your Review</h3>
                <div class="form-message" id="formMessage"></div>
                <div class="form-group">
                    <label for="reviewerName">Your Name</label>
                    <input type="text" id="reviewerName" placeholder="Enter your name">
                </div>
                <div class="form-group">
                    <label for="reviewRating">Rating</label>
                    <div class="star-rating">
                        <div class="stars-container">
                            <input type="radio" name="rating" value="5" id="star5" class="star-input">
                            <label for="star5" class="star-label">★</label>
                            <input type="radio" name="rating" value="4" id="star4" class="star-input">
                            <label for="star4" class="star-label">★</label>
                            <input type="radio" name="rating" value="3" id="star3" class="star-input">
                            <label for="star3" class="star-label">★</label>
                            <input type="radio" name="rating" value="2" id="star2" class="star-input">
                            <label for="star2" class="star-label">★</label>
                            <input type="radio" name="rating" value="1" id="star1" class="star-input">
                            <label for="star1" class="star-label">★</label>
                        </div>
                        <div class="rating-text" id="ratingText">Please select a rating</div>
                    </div>
                </div>
                <div class="form-group">
                    <label for="reviewText">Your Review</label>
                    <textarea id="reviewText" placeholder="Write your review here"></textarea>
                </div>
                <button class="submit-review-btn" id="submitReviewBtn">Submit Review</button>
            </div>

            <!-- Reviews Statistics -->
            <div style="margin-top: 40px;"></div>
            <div class="reviews-stats" id="reviewsStats">
                <div class="stat-card slide-up">
                    <div class="stat-number" id="totalReviews">-</div>
                    <div class="stat-label">Total Reviews</div>
                </div>
                <div class="stat-card slide-up" style="animation-delay: 0.1s">
                    <div class="stat-number" id="averageRating">-</div>
                    <div class="stat-label">Average Rating</div>
                </div>
                <div class="stat-card slide-up" style="animation-delay: 0.2s">
                    <div class="stat-number" id="recommendPercent">100%</div>
                    <div class="stat-label">Would Recommend</div>
                </div>
            </div>

            <div class="reviews-container">
                <!-- Rating Filters -->
                <div class="reviews-filters" id="reviewsFilters">
                    <button class="filter-btn active" data-rating="all">All Reviews</button>
                    <button class="filter-btn" data-rating="5">5 Stars</button>
                    <button class="filter-btn" data-rating="4">4 Stars</button>
                    <button class="filter-btn" data-rating="3">3 Stars</button>
                    <button class="filter-btn" data-rating="2">2 Stars</button>
                    <button class="filter-btn" data-rating="1">1 Star</button>
                </div>

                <!-- Loading State -->
                <div class="loading" id="reviewsLoading">
                    <div>Loading customer reviews...</div>
                </div>

                <!-- Reviews Grid -->
                <div class="reviews-grid" id="reviewsGrid" style="display: none;">
                    <!-- Reviews will be loaded here dynamically -->
                </div>

                <!-- No Reviews State -->
                <div class="no-reviews" id="noReviews" style="display: none;">
                    <h3>No Reviews Yet</h3>
                    <p>Be the first to share your experience at Grand Restaurant!</p>
                    <a href="contact.html" class="write-review-btn">Write a Review</a>
                </div>

                <!-- Pagination -->
                <div class="pagination" id="pagination" style="display: none;">
                    <button class="page-btn" id="prevPage" onclick="previousPage()">← Previous</button>
                    <span id="pageNumbers"></span>
                    <button class="page-btn" id="nextPage" onclick="nextPage()">Next →</button>
                </div>
            </div>
        </section>

        <!-- Cart Section (initially hidden) -->
        <div id="cart-container">
            <!-- Cart content will be loaded by JavaScript -->
        </div>

        <footer>
            <div class="footer-container">
                <div class="footer-section">
                    <p>&copy; 2024 Grand Restaurant. All Rights Reserved.</p>
                </div>
            </div>
        </footer>
    </div>

    <!-- Popup Modal -->
    <div class="popup-overlay" id="popupOverlay">
        <div class="popup-modal">
            <div class="popup-icon" id="popupIcon">✓</div>
            <div class="popup-title" id="popupTitle">Success!</div>
            <div class="popup-message" id="popupMessage">Your message goes here</div>
            <button class="popup-button" id="popupButton" onclick="closePopup()">OK</button>
        </div>
    </div>

    <script>
        // Reviews page specific variables
        let allReviews = [];
        let currentPage = 1;
        let reviewsPerPage = 9; // Increased to show more reviews per page
        let currentFilter = 'all';
        const API_BASE = 'api';

        // Initialize the page
        document.addEventListener('DOMContentLoaded', function() {
            console.log('[DEBUG] DOM Content Loaded - Starting initialization...');
            
            // Load reviews page functionality first
            loadReviewsPage();
            setupFilters();
            initializeStarRating();
            
            // Attach submit button event listener after a short delay to ensure DOM is fully ready
            setTimeout(() => {
                attachSubmitEventListener();
            }, 250);
            
            console.log('[DEBUG] Basic initialization complete');
            
            // Then load authentication (non-blocking)
            setTimeout(() => {
                checkUserAuthentication();
            }, 100);
        });

        // Function to attach submit button event listener
        function attachSubmitEventListener() {
            // Add debug info to verify event listener attachment
            console.log('[DEBUG] Attempting to attach event listener to submitReviewBtn');
            const submitBtn = document.getElementById('submitReviewBtn');
            console.log('[DEBUG] Submit button element:', submitBtn);
            
            if (!submitBtn) {
                console.error('[DEBUG] Submit button not found! Retrying in 500ms...');
                setTimeout(attachSubmitEventListener, 500);
                return;
            }

            // Check if event listener is already attached
            if (submitBtn.hasAttribute('data-listener-attached')) {
                console.log('[DEBUG] Event listener already attached, skipping...');
                return;
            }
            
            submitBtn.addEventListener('click', async function(event) {
                console.log('[DEBUG] Submit button clicked!');
                event.preventDefault(); // Prevent any default form submission
                
                const name = document.getElementById('reviewerName').value.trim();
                const rating = document.querySelector('input[name="rating"]:checked');
                const reviewText = document.getElementById('reviewText').value.trim();

                // Enhanced debug logging
                console.log('[DEBUG] Form validation details:', {
                    name: name,
                    nameLength: name.length,
                    rating: rating ? rating.value : 'null',
                    reviewText: reviewText,
                    reviewTextLength: reviewText.length,
                    nameEmpty: !name,
                    ratingEmpty: !rating,
                    reviewTextEmpty: !reviewText,
                    allFieldsFilled: !!(name && rating && reviewText),
                    reviewTextLongEnough: reviewText.length >= 10
                });

                // Validate fields with specific error messages
                console.log('[DEBUG] Starting field validation...');
                
                if (!name) {
                    console.log('[DEBUG] Validation failed: Name is empty');
                    showReviewMessage('Please enter your name.', 'error');
                    document.getElementById('reviewerName').focus();
                    return;
                }
                console.log('[DEBUG] Name validation passed');

                if (!rating) {
                    console.log('[DEBUG] Validation failed: No rating selected');
                    showReviewMessage('Please select a rating by clicking on the stars.', 'error');
                    return;
                }
                console.log('[DEBUG] Rating validation passed');

                if (!reviewText) {
                    console.log('[DEBUG] Validation failed: Review text is empty');
                    showReviewMessage('Please write your review.', 'error');
                    document.getElementById('reviewText').focus();
                    return;
                }
                console.log('[DEBUG] Review text validation passed');

                if (reviewText.length < 10) {
                    console.log('[DEBUG] Validation failed: Review text too short');
                    showReviewMessage('Please write at least 10 characters for your review.', 'error');
                    document.getElementById('reviewText').focus();
                    return;
                }
                console.log('[DEBUG] All validations passed, proceeding with submission...');

                const reviewData = {
                    customer_name: name,
                    rating: rating.value,
                    review_text: reviewText,
                    created_at: new Date().toISOString() // Use current date for submission
                };

                try {
                    const response = await fetch(`${API_BASE}/reviews.php`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify(reviewData)
                    });

                    if (!response.ok) {
                        throw new Error('Network response was not ok');
                    }

                    const result = await response.json();
                    console.log('Review submitted:', result);

                    // Reset form fields
                    document.getElementById('reviewerName').value = '';
                    const selectedRating = document.querySelector('input[name="rating"]:checked');
                    if (selectedRating) {
                        selectedRating.checked = false;
                    }
                    document.getElementById('reviewText').value = '';
                    resetStars();
                    document.getElementById('ratingText').textContent = 'Please select a rating';
                    document.getElementById('ratingText').style.color = '#666';
                    document.getElementById('ratingText').style.fontWeight = 'normal';

                    // Close the form
                    document.getElementById('reviewSubmissionForm').style.display = 'none';

                    // Reload reviews
                    loadReviewsPage();

                    showReviewMessage('Thank you for your review! It has been submitted for moderation.', 'success');
                } catch (error) {
                    console.error('Error submitting review:', error);
                    showReviewMessage('There was an error submitting your review. Please try again later.', 'error');
                }
            });

            // Mark that the event listener has been attached
            submitBtn.setAttribute('data-listener-attached', 'true');
            console.log('[DEBUG] Event listener successfully attached to submit button');
        }

        // Load all reviews and statistics
        async function loadReviewsPage() {
            try {
                console.log('[Reviews Page] Loading reviews page...');
                
                // Load reviews and statistics in parallel
                const [reviewsResponse, statsResponse] = await Promise.all([
                    fetch(`${API_BASE}/reviews.php`),
                    fetch(`${API_BASE}/reviews.php?statistics=1`)
                ]);

                console.log('[Reviews Page] Reviews API response status:', reviewsResponse.status);
                console.log('[Reviews Page] Statistics API response status:', statsResponse.status);

                if (!reviewsResponse.ok) {
                    throw new Error(`Reviews API error: ${reviewsResponse.status}`);
                }
                
                if (!statsResponse.ok) {
                    throw new Error(`Statistics API error: ${statsResponse.status}`);
                }

                const reviews = await reviewsResponse.json();
                const stats = await statsResponse.json();

                console.log(`[Reviews Page] Loaded ${reviews.length} reviews`);
                console.log('[Reviews Page] Statistics:', stats);

                allReviews = reviews;
                displayReviewsStatistics(stats);
                
                // Apply the current filter before displaying reviews
                const filteredReviews = currentFilter === 'all' 
                    ? reviews 
                    : reviews.filter(review => review.rating == currentFilter);
                
                displayReviews(filteredReviews);

            } catch (error) {
                console.error('[Reviews Page] Error loading reviews:', error);
                showErrorState();
            }
        }

        // Display review statistics
        function displayReviewsStatistics(stats) {
            document.getElementById('totalReviews').textContent = stats.total_reviews || 0;
            document.getElementById('averageRating').textContent = stats.average_rating ? `${stats.average_rating}/5` : 'N/A';
        }

        // Display reviews in grid format
        function displayReviews(reviews) {
            const reviewsGrid = document.getElementById('reviewsGrid');
            const reviewsLoading = document.getElementById('reviewsLoading');
            const noReviews = document.getElementById('noReviews');
            const pagination = document.getElementById('pagination');

            console.log(`[Reviews Page] Displaying reviews: ${reviews ? reviews.length : 0} total`);
            reviewsLoading.style.display = 'none';

            if (!reviews || reviews.length === 0) {
                console.log('[Reviews Page] No reviews to display');
                noReviews.style.display = 'block';
                reviewsGrid.style.display = 'none';
                pagination.style.display = 'none';
                return;
            }

            noReviews.style.display = 'none';
            reviewsGrid.style.display = 'grid';

            // No need to filter reviews again - we now pass in already filtered reviews
            // from the pagination functions
            const filteredReviews = reviews;

            console.log(`[Reviews Page] Filtered reviews: ${filteredReviews.length} (filter: ${currentFilter})`);

            // Paginate reviews
            const startIndex = (currentPage - 1) * reviewsPerPage;
            const endIndex = startIndex + reviewsPerPage;
            const paginatedReviews = filteredReviews.slice(startIndex, endIndex);

            console.log(`[Reviews Page] Showing page ${currentPage}: reviews ${startIndex + 1}-${Math.min(endIndex, filteredReviews.length)} of ${filteredReviews.length}`);

            // Generate review cards
            reviewsGrid.innerHTML = paginatedReviews.map((review, index) => `
                <div class="review-card slide-up" style="animation-delay: ${index * 0.1}s">
                    <div class="review-header">
                        <div class="reviewer-avatar">
                            ${review.customer_name.charAt(0).toUpperCase()}
                        </div>
                        <div class="reviewer-info">
                            <h3>${review.customer_name}</h3>
                            <div class="review-date">${formatDate(review.created_at)}</div>
                        </div>
                    </div>
                    
                    <div class="review-rating">
                        ${generateStarRating(review.rating)}
                    </div>
                    
                    <div class="review-text">
                        ${review.review_text}
                    </div>
                    
                    <div class="review-helpful">
                        <button class="helpful-btn" onclick="markHelpful(${review.id})">
                            👍 Helpful
                        </button>
                        <span style="color: #888; font-size: 0.9em;">
                            ${Math.floor(Math.random() * 10) + 1} people found this helpful
                        </span>
                    </div>
                </div>
            `).join('');

            console.log(`[Reviews Page] Generated ${paginatedReviews.length} review cards`);

            // Setup pagination
            setupPagination(filteredReviews.length);
        }

        // Generate star rating HTML
        function generateStarRating(rating) {
            let stars = '';
            for (let i = 1; i <= 5; i++) {
                if (i <= rating) {
                    stars += '<span class="star">★</span>';
                } else {
                    stars += '<span class="star empty">★</span>';
                }
            }
            return stars;
        }

        // Format date for display
        function formatDate(dateString) {
            const date = new Date(dateString);
            const options = { 
                year: 'numeric', 
                month: 'long', 
                day: 'numeric' 
            };
            return date.toLocaleDateString('en-US', options);
        }

        // Setup filter buttons
        function setupFilters() {
            const filterButtons = document.querySelectorAll('.filter-btn');
            
            filterButtons.forEach(button => {
                button.addEventListener('click', function() {
                    // Remove active class from all buttons
                    filterButtons.forEach(btn => btn.classList.remove('active'));
                    
                    // Add active class to clicked button
                    this.classList.add('active');
                    
                    // Update current filter
                    currentFilter = this.dataset.rating;
                    currentPage = 1; // Reset to first page
                    
                    console.log(`[Reviews Page] Filter changed to: ${currentFilter}`);
                    
                    // Filter reviews based on selected filter
                    const filteredReviews = currentFilter === 'all' 
                        ? allReviews 
                        : allReviews.filter(review => review.rating == currentFilter);
                    
                    // Re-display reviews with new filter
                    displayReviews(filteredReviews);
                });
            });
        }

        // Setup pagination
        function setupPagination(totalReviews) {
            const pagination = document.getElementById('pagination');
            const totalPages = Math.ceil(totalReviews / reviewsPerPage);

            if (totalPages <= 1) {
                pagination.style.display = 'none';
                return;
            }

            pagination.style.display = 'flex';

            // Update previous/next buttons
            const prevBtn = document.getElementById('prevPage');
            const nextBtn = document.getElementById('nextPage');
            
            prevBtn.disabled = currentPage === 1;
            nextBtn.disabled = currentPage === totalPages;

            // Generate page numbers
            const pageNumbers = document.getElementById('pageNumbers');
            let pageNumbersHTML = '';
            
            for (let i = 1; i <= totalPages; i++) {
                pageNumbersHTML += `
                    <button class="page-btn ${i === currentPage ? 'active' : ''}" 
                            onclick="goToPage(${i})">${i}</button>
                `;
            }
            
            pageNumbers.innerHTML = pageNumbersHTML;
        }

        // Pagination functions
        function previousPage() {
            if (currentPage > 1) {
                currentPage--;
                const filteredReviews = currentFilter === 'all' 
                    ? allReviews 
                    : allReviews.filter(review => review.rating == currentFilter);
                displayReviews(filteredReviews); // Fixed: Use filtered reviews instead of all reviews
            }
        }

        function nextPage() {
            const filteredReviews = currentFilter === 'all' 
                ? allReviews 
                : allReviews.filter(review => review.rating == currentFilter);
            const totalPages = Math.ceil(filteredReviews.length / reviewsPerPage);
            
            if (currentPage < totalPages) {
                currentPage++;
                displayReviews(filteredReviews); // Fixed: Use filtered reviews instead of all reviews
            }
        }

        function goToPage(pageNumber) {
            currentPage = pageNumber;
            const filteredReviews = currentFilter === 'all' 
                ? allReviews 
                : allReviews.filter(review => review.rating == currentFilter);
            displayReviews(filteredReviews); // Fixed: Use filtered reviews instead of all reviews
        }

        // Mark review as helpful (placeholder function)
        function markHelpful(reviewId) {
            // This could be implemented to track helpful votes
            alert('Thank you for your feedback!');
        }

        // Show error state
        function showErrorState() {
            const reviewsLoading = document.getElementById('reviewsLoading');
            reviewsLoading.innerHTML = `
                <div class="error-card">
                    <div class="error-icon-circle">
                        <i class="fas fa-exclamation-triangle"></i>
                    </div>
                    <h3 class="error-title">Oops! Something went wrong</h3>
                    <p class="error-message">We're experiencing technical difficulties loading the reviews. This could be due to:</p>
                    <ul class="error-suggestions">
                        <li>Temporary server maintenance</li>
                        <li>Network connectivity issues</li>
                        <li>High traffic volume</li>
                    </ul>
                    <div class="error-actions">
                        <button onclick="loadReviewsPage()" class="retry-btn">
                            <i class="fas fa-sync-alt"></i>
                            Try Again
                        </button>
                        <button onclick="window.location.reload()" class="secondary-btn">
                            <i class="fas fa-refresh"></i>
                            Refresh Page
                        </button>
                    </div>
                </div>
            `;
        }

        // User Authentication Management (reused from other pages)
        async function checkUserAuthentication() {
            try {
                const response = await fetch('api/auth.php?action=check_session');
                const result = await response.json();

                const guestLinks = document.getElementById('guestLinks');
                const userLinks = document.getElementById('userLinks');

                if (result.logged_in) {
                    guestLinks.style.display = 'none';
                    userLinks.style.display = 'inline';
                } else {
                    guestLinks.style.display = 'inline';
                    userLinks.style.display = 'none';
                }
            } catch (error) {
                console.error('Authentication check error:', error);
                document.getElementById('guestLinks').style.display = 'inline';
                document.getElementById('userLinks').style.display = 'none';
            }
        }

        async function logout() {
            if (confirm('Are you sure you want to logout?')) {
                try {
                    await fetch('api/auth.php', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            action: 'logout'
                        })
                    });

                    localStorage.removeItem('user');
                    checkUserAuthentication();
                    alert('Logged out successfully!');
                } catch (error) {
                    console.error('Logout error:', error);
                    alert('Error logging out. Please try again.');
                }
            }
        }

        // Review Submission Form Handling
        document.getElementById('toggleReviewForm').addEventListener('click', function() {
            const form = document.getElementById('reviewSubmissionForm');
            form.style.display = form.style.display === 'none' || form.style.display === '' ? 'block' : 'none';
            if (form.style.display === 'block') {
                form.classList.add('show');
                document.getElementById('formMessage').style.display = 'none'; // Hide message on new form open
            }
        });

        function showReviewMessage(message, type) {
            // Update popup content
            const popupOverlay = document.getElementById('popupOverlay');
            const popupIcon = document.getElementById('popupIcon');
            const popupTitle = document.getElementById('popupTitle');
            const popupMessage = document.getElementById('popupMessage');
            const popupButton = document.getElementById('popupButton');

            // Set content based on type
            if (type === 'success') {
                popupIcon.textContent = '✓';
                popupIcon.className = 'popup-icon success';
                popupTitle.textContent = 'Success!';
                popupButton.className = 'popup-button';
            } else {
                popupIcon.textContent = '✗';
                popupIcon.className = 'popup-icon error';
                popupTitle.textContent = 'Error';
                popupButton.className = 'popup-button error';
            }

            popupMessage.textContent = message;

            // Show the popup
            popupOverlay.style.display = 'block';
        }

        // Function to close the popup
        function closePopup() {
            const popupOverlay = document.getElementById('popupOverlay');
            popupOverlay.style.display = 'none';
        }

        // Close popup when clicking on overlay
        document.addEventListener('DOMContentLoaded', function() {
            const popupOverlay = document.getElementById('popupOverlay');
            popupOverlay.addEventListener('click', function(event) {
                if (event.target === popupOverlay) {
                    closePopup();
                }
            });
        });

        // Star Rating Interactive Functionality
        function initializeStarRating() {
            const starLabels = document.querySelectorAll('.star-label');
            const ratingText = document.getElementById('ratingText');
            const ratingTexts = {
                1: 'Poor - Not satisfied',
                2: 'Fair - Below expectations',
                3: 'Good - Meets expectations',
                4: 'Very Good - Above expectations',
                5: 'Excellent - Outstanding!'
            };

            starLabels.forEach((star, index) => {
                const rating = 5 - index; // Stars are in reverse order (5 to 1)
                
                // Handle hover effect
                star.addEventListener('mouseenter', function() {
                    highlightStars(rating);
                    ratingText.textContent = ratingTexts[rating];
                    ratingText.style.color = '#8B5A2B';
                });

                // Handle click to select rating
                star.addEventListener('click', function() {
                    const radioInput = document.getElementById(`star${rating}`);
                    radioInput.checked = true;
                    highlightStars(rating);
                    ratingText.textContent = ratingTexts[rating];
                    ratingText.style.color = '#8B5A2B';
                    ratingText.style.fontWeight = 'bold';
                });
            });

            // Reset on mouse leave
            const starContainer = document.querySelector('.stars-container');
            if (starContainer) {
                starContainer.addEventListener('mouseleave', function() {
                    const selectedRating = document.querySelector('input[name="rating"]:checked');
                    if (selectedRating) {
                        highlightStars(selectedRating.value);
                        ratingText.textContent = ratingTexts[selectedRating.value];
                        ratingText.style.color = '#8B5A2B';
                        ratingText.style.fontWeight = 'bold';
                    } else {
                        resetStars();
                        ratingText.textContent = 'Please select a rating';
                        ratingText.style.color = '#666';
                        ratingText.style.fontWeight = 'normal';
                    }
                });
            }
        }

        function highlightStars(rating) {
            const starLabels = document.querySelectorAll('.star-label');
            starLabels.forEach((star, index) => {
                const starRating = 5 - index;
                if (starRating <= rating) {
                    star.style.color = '#ffd700';
                    star.style.transform = 'scale(1.1)';
                } else {
                    star.style.color = '#ddd';
                    star.style.transform = 'scale(1)';
                }
            });
        }

        function resetStars() {
            const starLabels = document.querySelectorAll('.star-label');
            starLabels.forEach(star => {
                star.style.color = '#ddd';
                star.style.transform = 'scale(1)';
            });
        }
    </script>
</body>
</html>
