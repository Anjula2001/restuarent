<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Duplicate Reservation Fix Verification</title>
    <style>
        body { 
            font-family: Arial, sans-serif; 
            margin: 20px; 
            background: #f5f5f5;
        }
        .container { 
            max-width: 1000px; 
            margin: 0 auto; 
            background: white; 
            padding: 20px; 
            border-radius: 8px; 
        }
        .test-section { 
            margin: 20px 0; 
            padding: 20px; 
            border: 1px solid #ddd; 
            border-radius: 5px; 
            background: #f9f9f9;
        }
        .success { 
            background: #d4edda; 
            border: 1px solid #c3e6cb; 
            padding: 10px; 
            border-radius: 4px; 
            color: #155724; 
        }
        .error { 
            background: #f8d7da; 
            border: 1px solid #f5c6cb; 
            padding: 10px; 
            border-radius: 4px; 
            color: #721c24; 
        }
        .warning { 
            background: #fff3cd; 
            border: 1px solid #ffeaa7; 
            padding: 10px; 
            border-radius: 4px; 
            color: #856404; 
        }
        button { 
            background: #007bff; 
            color: white; 
            padding: 10px 20px; 
            border: none; 
            border-radius: 4px; 
            cursor: pointer; 
            margin: 5px;
        }
        button:hover { background: #0056b3; }
        button:disabled { 
            background: #6c757d; 
            cursor: not-allowed; 
        }
        table { 
            width: 100%; 
            border-collapse: collapse; 
            margin: 10px 0; 
        }
        th, td { 
            border: 1px solid #ddd; 
            padding: 8px; 
            text-align: left; 
        }
        th { background: #f8f9fa; }
        .duplicate-row { background: #ffebee; }
        pre { 
            background: #f4f4f4; 
            padding: 10px; 
            border-radius: 4px; 
            overflow-x: auto; 
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîß Duplicate Reservation Fix Verification</h1>
        <p><strong>Test Date:</strong> <span id="testDate"></span></p>
        <p><strong>Status:</strong> Post-cleanup verification of duplicate reservation fix</p>
        
        <div class="success">
            <h3>‚úÖ Fix Summary</h3>
            <ul>
                <li><strong>Issue:</strong> Duplicate reservations appearing in admin panel after form submission</li>
                <li><strong>Root Cause:</strong> Multiple event listeners and lack of duplicate prevention</li>
                <li><strong>Resolution:</strong> Removed duplicate event listeners, added UI protection, implemented backend duplicate prevention</li>
                <li><strong>Database Cleanup:</strong> Cancelled existing duplicate reservations</li>
            </ul>
        </div>

        <div class="test-section">
            <h2>üìä Current Database State</h2>
            <button onclick="loadCurrentReservations()">Load Current Reservations</button>
            <div id="currentReservations"></div>
        </div>

        <div class="test-section">
            <h2>üß™ Duplicate Prevention Test</h2>
            <button onclick="testDuplicatePrevention()">Test Duplicate Prevention</button>
            <div id="duplicateTest"></div>
        </div>

        <div class="test-section">
            <h2>‚ö° Rapid Click Simulation</h2>
            <button onclick="testRapidClicks()">Simulate Rapid Form Submissions</button>
            <div id="rapidClickTest"></div>
        </div>

        <div class="test-section">
            <h2>üè¢ Admin Panel Verification</h2>
            <button onclick="testAdminPanel()">Test Admin Panel Display</button>
            <div id="adminPanelTest"></div>
        </div>

        <div class="test-section">
            <h2>üìù System Status Report</h2>
            <button onclick="generateReport()">Generate Complete Report</button>
            <div id="systemReport"></div>
        </div>
    </div>

    <script>
        document.getElementById('testDate').textContent = new Date().toLocaleString();
        
        async function loadCurrentReservations() {
            const resultDiv = document.getElementById('currentReservations');
            resultDiv.innerHTML = '<div class="warning">Loading current reservations...</div>';
            
            try {
                const response = await fetch('/restuarent/api/reservations.php');
                const reservations = await response.json();
                
                if (Array.isArray(reservations)) {
                    // Find duplicates
                    const duplicates = findDuplicateReservations(reservations);
                    
                    let html = `<h3>Database Status (${reservations.length} total reservations)</h3>`;
                    
                    if (duplicates.length > 0) {
                        html += `<div class="error">
                            <h4>‚ö†Ô∏è ${duplicates.length} Duplicate Groups Found</h4>
                            <p>These duplicates should be addressed:</p>
                        </div>`;
                    } else {
                        html += `<div class="success">
                            <h4>‚úÖ No Active Duplicates Found</h4>
                            <p>Database is clean of duplicate reservations</p>
                        </div>`;
                    }
                    
                    // Show recent reservations
                    html += '<h4>Recent Reservations:</h4>';
                    html += '<table><tr><th>ID</th><th>Name</th><th>Email</th><th>Date</th><th>Time</th><th>Status</th></tr>';
                    
                    reservations.slice(0, 10).forEach(res => {
                        const isDuplicate = duplicates.some(dup => dup.ids.includes(res.id));
                        const rowClass = isDuplicate ? 'duplicate-row' : '';
                        html += `<tr class="${rowClass}">
                            <td>#${res.id}</td>
                            <td>${res.name}</td>
                            <td>${res.email}</td>
                            <td>${res.date}</td>
                            <td>${res.time}</td>
                            <td>${res.status}</td>
                        </tr>`;
                    });
                    
                    html += '</table>';
                    resultDiv.innerHTML = html;
                } else {
                    resultDiv.innerHTML = '<div class="error">Invalid response format</div>';
                }
            } catch (error) {
                resultDiv.innerHTML = `<div class="error">Error loading reservations: ${error.message}</div>`;
            }
        }

        async function testDuplicatePrevention() {
            const resultDiv = document.getElementById('duplicateTest');
            resultDiv.innerHTML = '<div class="warning">Testing duplicate prevention...</div>';
            
            const testData = {
                name: "Duplicate Test User",
                email: "duplicate.test@example.com",
                phone: "555-DUPE",
                date: "2025-06-16",
                time: "19:00",
                guests: 2,
                special_requests: "Testing duplicate prevention system"
            };
            
            try {
                // First request
                const response1 = await fetch('/restuarent/api/reservations.php', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(testData)
                });
                const result1 = await response1.json();
                
                // Immediate second request (should be blocked)
                const response2 = await fetch('/restuarent/api/reservations.php', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(testData)
                });
                const result2 = await response2.json();
                
                let html = '<h3>Duplicate Prevention Results:</h3>';
                
                if (response1.ok && result1.success) {
                    html += `<div class="success">
                        ‚úÖ <strong>First Request:</strong> Successfully created reservation (ID: ${result1.id})
                    </div>`;
                } else {
                    html += `<div class="error">
                        ‚ùå <strong>First Request:</strong> Failed - ${result1.error || result1.message}
                    </div>`;
                }
                
                if (!response2.ok || result2.error) {
                    html += `<div class="success">
                        ‚úÖ <strong>Second Request:</strong> Properly blocked as duplicate<br>
                        <em>Message: ${result2.error || result2.message}</em>
                    </div>`;
                } else {
                    html += `<div class="error">
                        ‚ùå <strong>Second Request:</strong> NOT BLOCKED (This indicates a problem!)<br>
                        <em>Created ID: ${result2.id}</em>
                    </div>`;
                }
                
                resultDiv.innerHTML = html;
                
            } catch (error) {
                resultDiv.innerHTML = `<div class="error">Test failed: ${error.message}</div>`;
            }
        }

        async function testRapidClicks() {
            const resultDiv = document.getElementById('rapidClickTest');
            resultDiv.innerHTML = '<div class="warning">Testing rapid click simulation...</div>';
            
            const testData = {
                name: "Rapid Click Test",
                email: "rapid.test@example.com",
                phone: "555-RAPID",
                date: "2025-06-17",
                time: "20:30",
                guests: 3,
                special_requests: "Rapid click test"
            };
            
            try {
                // Simulate 5 rapid requests
                const promises = [];
                for (let i = 0; i < 5; i++) {
                    promises.push(
                        fetch('/restuarent/api/reservations.php', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(testData)
                        })
                    );
                }
                
                const responses = await Promise.all(promises);
                const results = await Promise.all(responses.map(r => r.json()));
                
                let successCount = 0;
                let blockedCount = 0;
                let html = '<h3>Rapid Click Test Results:</h3>';
                
                results.forEach((result, index) => {
                    if (result.success) {
                        successCount++;
                        html += `<p>Request ${index + 1}: ‚úÖ SUCCESS (ID: ${result.id})</p>`;
                    } else {
                        blockedCount++;
                        html += `<p>Request ${index + 1}: üö´ BLOCKED (${result.error})</p>`;
                    }
                });
                
                const status = successCount === 1 ? 'success' : 'error';
                html += `<div class="${status}">
                    <h4>Summary:</h4>
                    <p>Successful reservations: ${successCount}</p>
                    <p>Blocked duplicates: ${blockedCount}</p>
                    <p><strong>${successCount === 1 ? '‚úÖ PERFECT! Only one reservation created.' : '‚ùå Multiple reservations created - investigation needed!'}</strong></p>
                </div>`;
                
                resultDiv.innerHTML = html;
                
            } catch (error) {
                resultDiv.innerHTML = `<div class="error">Test failed: ${error.message}</div>`;
            }
        }

        async function testAdminPanel() {
            const resultDiv = document.getElementById('adminPanelTest');
            resultDiv.innerHTML = '<div class="warning">Testing admin panel data loading...</div>';
            
            try {
                const response = await fetch('/restuarent/api/reservations.php');
                const reservations = await response.json();
                
                if (Array.isArray(reservations)) {
                    const activeDuplicates = findDuplicateReservations(reservations.filter(r => r.status === 'pending' || r.status === 'confirmed'));
                    
                    let html = '<h3>Admin Panel Test Results:</h3>';
                    
                    if (activeDuplicates.length === 0) {
                        html += `<div class="success">
                            ‚úÖ <strong>Admin Panel Status:</strong> No active duplicate reservations found<br>
                            <em>Admin panel should display cleanly without duplicate rows</em>
                        </div>`;
                    } else {
                        html += `<div class="error">
                            ‚ùå <strong>Admin Panel Status:</strong> ${activeDuplicates.length} active duplicate groups found<br>
                            <em>Admin panel may still show duplicate rows</em>
                        </div>`;
                    }
                    
                    html += `<p><strong>Total Reservations:</strong> ${reservations.length}</p>`;
                    html += `<p><strong>Active Reservations:</strong> ${reservations.filter(r => r.status !== 'cancelled').length}</p>`;
                    
                    resultDiv.innerHTML = html;
                } else {
                    resultDiv.innerHTML = '<div class="error">Invalid API response</div>';
                }
            } catch (error) {
                resultDiv.innerHTML = `<div class="error">Test failed: ${error.message}</div>`;
            }
        }

        async function generateReport() {
            const resultDiv = document.getElementById('systemReport');
            resultDiv.innerHTML = '<div class="warning">Generating system report...</div>';
            
            try {
                const response = await fetch('/restuarent/api/reservations.php');
                const reservations = await response.json();
                
                if (Array.isArray(reservations)) {
                    const duplicates = findDuplicateReservations(reservations);
                    const activeReservations = reservations.filter(r => r.status !== 'cancelled');
                    const activeDuplicates = findDuplicateReservations(activeReservations);
                    
                    const report = {
                        timestamp: new Date().toISOString(),
                        totalReservations: reservations.length,
                        activeReservations: activeReservations.length,
                        cancelledReservations: reservations.filter(r => r.status === 'cancelled').length,
                        totalDuplicateGroups: duplicates.length,
                        activeDuplicateGroups: activeDuplicates.length,
                        systemStatus: activeDuplicates.length === 0 ? 'HEALTHY' : 'NEEDS_ATTENTION'
                    };
                    
                    let html = '<h3>System Status Report</h3>';
                    html += `<div class="${report.systemStatus === 'HEALTHY' ? 'success' : 'error'}">
                        <h4>Overall Status: ${report.systemStatus}</h4>
                        <p><strong>Health Check:</strong> ${report.systemStatus === 'HEALTHY' ? '‚úÖ System is functioning correctly' : '‚ö†Ô∏è Issues detected that need attention'}</p>
                    </div>`;
                    
                    html += '<h4>Statistics:</h4>';
                    html += '<ul>';
                    html += `<li>Total Reservations: ${report.totalReservations}</li>`;
                    html += `<li>Active Reservations: ${report.activeReservations}</li>`;
                    html += `<li>Cancelled Reservations: ${report.cancelledReservations}</li>`;
                    html += `<li>Total Duplicate Groups: ${report.totalDuplicateGroups}</li>`;
                    html += `<li>Active Duplicate Groups: ${report.activeDuplicateGroups}</li>`;
                    html += '</ul>';
                    
                    html += '<h4>Fix Implementation Status:</h4>';
                    html += '<ul>';
                    html += '<li>‚úÖ Frontend: Duplicate event listeners removed</li>';
                    html += '<li>‚úÖ Backend: Duplicate prevention logic implemented</li>';
                    html += '<li>‚úÖ Database: Existing duplicates cancelled</li>';
                    html += '<li>‚úÖ UI Protection: Form submission button disabling added</li>';
                    html += '</ul>';
                    
                    if (report.systemStatus === 'HEALTHY') {
                        html += '<div class="success"><h4>üéâ Resolution Complete!</h4><p>The duplicate reservation issue has been successfully resolved. Users can now submit reservations without creating duplicates, and the admin panel displays clean data.</p></div>';
                    }
                    
                    html += '<h4>Raw Report Data:</h4>';
                    html += `<pre>${JSON.stringify(report, null, 2)}</pre>`;
                    
                    resultDiv.innerHTML = html;
                } else {
                    resultDiv.innerHTML = '<div class="error">Failed to generate report</div>';
                }
            } catch (error) {
                resultDiv.innerHTML = `<div class="error">Report generation failed: ${error.message}</div>`;
            }
        }

        function findDuplicateReservations(reservations) {
            const groups = {};
            
            reservations.forEach(res => {
                const key = `${res.email}|${res.date}|${res.time}`;
                if (!groups[key]) {
                    groups[key] = {
                        email: res.email,
                        date: res.date,
                        time: res.time,
                        ids: [],
                        count: 0
                    };
                }
                groups[key].ids.push(res.id);
                groups[key].count++;
            });
            
            // Return only groups with more than one reservation
            return Object.values(groups).filter(group => group.count > 1);
        }
    </script>
</body>
</html>
