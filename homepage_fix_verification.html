<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Homepage Fix Verification</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .popular-foods { padding: 20px; }
        .food-cards { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; }
        .food-card { border: 1px solid #ddd; padding: 15px; border-radius: 8px; }
        .food-card img { width: 100%; height: 150px; object-fit: cover; }
        .api-items { background-color: #e8f5e8; }
        .fallback-items { background-color: #ffe8e8; }
        .status { padding: 10px; margin: 10px 0; border-radius: 5px; }
        .success { background-color: #d4edda; color: #155724; }
        .error { background-color: #f8d7da; color: #721c24; }
    </style>
</head>
<body>
    <h1>Homepage Popular Foods Fix Verification</h1>
    
    <div id="status" class="status">Testing...</div>
    
    <section class="popular-foods">
        <h2>Popular Food Items (Current Implementation)</h2>
        <div class="food-cards" id="food-cards">
            Loading...
        </div>
    </section>

    <script>
        // Add cache busting parameter to force fresh API call
        const API_BASE = 'api';
        const cacheBuster = Date.now();

        async function loadMenuItems() {
            const statusDiv = document.getElementById('status');
            const foodCards = document.querySelector('.food-cards');
            
            try {
                statusDiv.innerHTML = 'Making API call...';
                statusDiv.className = 'status';
                
                // Add cache buster to ensure fresh data
                const response = await fetch(`${API_BASE}/menu.php?popular=true&limit=3&_t=${cacheBuster}`);
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const popularItems = await response.json();
                
                console.log('API Response:', popularItems);
                
                if (!Array.isArray(popularItems)) {
                    throw new Error('API response is not an array');
                }
                
                if (popularItems.length === 0) {
                    throw new Error('API returned empty array');
                }
                
                // Process items exactly like the original function
                const processedItems = popularItems.map(item => ({
                    id: item.id,
                    name: item.name,
                    description: item.description || `Delicious ${item.name.toLowerCase()}`,
                    price: parseFloat(item.price).toFixed(2),
                    image_url: item.image_url || 'images/popular/2.png'
                }));
                
                // Display API items with success styling
                foodCards.innerHTML = processedItems.map(item => `
                    <div class="food-card api-items">
                        <img src="${item.image_url}" alt="${item.name}" 
                             onerror="this.src='images/popular/2.png';">
                        <h3>${item.name} ✅</h3>
                        <p><strong>FROM API:</strong> ${item.description}</p>
                        <p><strong>Price:</strong> Rs. ${item.price}</p>
                        <p><strong>Category:</strong> ${popularItems.find(orig => orig.id === item.id).category}</p>
                    </div>
                `).join('');
                
                statusDiv.innerHTML = `✅ SUCCESS: Loaded ${popularItems.length} items from API`;
                statusDiv.className = 'status success';
                
                // Verify these items appear on menu page
                verifyMenuPageSync(popularItems);
                
            } catch (error) {
                console.error('Error loading popular items:', error);
                
                // Show fallback items
                const fallbackItems = [
                    { id: 'popular-1', name: 'String Hoppers', description: 'Sri Lankan delicacy', price: '350.00' },
                    { id: 'popular-2', name: 'Kottu Roti', description: 'Street food favorite', price: '750.00' },
                    { id: 'popular-3', name: 'Fish Ambulthiyal', description: 'Tangy fish curry', price: '950.00' }
                ];
                
                foodCards.innerHTML = fallbackItems.map(item => `
                    <div class="food-card fallback-items">
                        <h3>${item.name} ⚠️</h3>
                        <p><strong>FALLBACK:</strong> ${item.description}</p>
                        <p><strong>Price:</strong> Rs. ${item.price}</p>
                    </div>
                `).join('');
                
                statusDiv.innerHTML = `❌ ERROR: ${error.message} - Showing fallback items`;
                statusDiv.className = 'status error';
            }
        }
        
        async function verifyMenuPageSync(popularItems) {
            try {
                // Check if these items appear in menu.php (all items)
                const allMenuResponse = await fetch(`${API_BASE}/menu.php?_t=${cacheBuster}`);
                const allMenuItems = await allMenuResponse.json();
                
                const popularItemIds = popularItems.map(item => item.id);
                const foundInMenu = allMenuItems.filter(item => popularItemIds.includes(item.id));
                
                console.log('Popular items found in menu:', foundInMenu);
                
                const syncStatus = document.createElement('div');
                syncStatus.className = 'status ' + (foundInMenu.length === popularItems.length ? 'success' : 'error');
                syncStatus.innerHTML = foundInMenu.length === popularItems.length 
                    ? `✅ SYNC CHECK: All ${popularItems.length} popular items are available in menu`
                    : `⚠️ SYNC ISSUE: Only ${foundInMenu.length}/${popularItems.length} popular items found in menu`;
                
                document.body.appendChild(syncStatus);
                
            } catch (error) {
                console.error('Error verifying menu sync:', error);
            }
        }

        // Load immediately when DOM is ready
        document.addEventListener('DOMContentLoaded', loadMenuItems);
    </script>
</body>
</html>
