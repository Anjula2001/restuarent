<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Comprehensive Rice & Curry Test</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; background: #f5f5f5; }
        .test-container { background: white; padding: 20px; margin: 10px 0; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .step { margin: 20px 0; padding: 15px; border-left: 4px solid #007bff; background: #f8f9fa; }
        .success { border-left-color: #28a745; background: #d4edda; }
        .error { border-left-color: #dc3545; background: #f8d7da; }
        .warning { border-left-color: #ffc107; background: #fff3cd; }
        .food-card { border: 1px solid #ddd; padding: 15px; margin: 10px 0; border-radius: 8px; background: white; }
        .food-card h4 { margin: 0 0 10px 0; color: #333; }
        .food-card p { margin: 5px 0; color: #666; }
        .price { font-weight: bold; color: #28a745; }
        button { padding: 10px 20px; margin: 5px; border: none; border-radius: 5px; cursor: pointer; background: #007bff; color: white; }
        button:hover { background: #0056b3; }
        .log { background: #f8f9fa; border: 1px solid #dee2e6; padding: 10px; margin: 10px 0; border-radius: 4px; font-family: monospace; font-size: 12px; max-height: 200px; overflow-y: auto; }
        .highlight { background: #fff3cd; padding: 2px 4px; border-radius: 3px; }
    </style>
</head>
<body>
    <h1>üçõ Comprehensive Rice & Curry Display Test</h1>
    
    <div class="test-container">
        <h2>Current Status Dashboard</h2>
        <div id="status-dashboard">
            <div class="step">
                <strong>Test Status:</strong> <span id="overall-status">Not Started</span><br>
                <strong>API Status:</strong> <span id="api-status">Unknown</span><br>
                <strong>Items Found:</strong> <span id="items-found">-</span><br>
                <strong>Display Status:</strong> <span id="display-status">Unknown</span>
            </div>
        </div>
    </div>

    <div class="test-container">
        <h2>Step-by-Step Testing</h2>
        <button onclick="runCompleteTest()">üöÄ Run Complete Test</button>
        <button onclick="runIndividualTests()">üîç Run Individual Tests</button>
        <button onclick="clearResults()">üßπ Clear Results</button>
        
        <div id="test-results"></div>
    </div>

    <div class="test-container">
        <h2>Rice & Curry Items Display</h2>
        <div id="rice-curry-display">
            <p style="color: #666; font-style: italic;">Items will appear here after testing...</p>
        </div>
    </div>

    <div class="test-container">
        <h2>Console Log</h2>
        <div id="console-log" class="log">
            Console output will appear here...
        </div>
    </div>

    <script>
        let testLog = [];
        
        function logMessage(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = `[${timestamp}] ${message}`;
            testLog.push(logEntry);
            
            const consoleDiv = document.getElementById('console-log');
            const colorClass = type === 'error' ? 'error' : type === 'success' ? 'success' : 'info';
            consoleDiv.innerHTML += `<div class="${colorClass}">${logEntry}</div>`;
            consoleDiv.scrollTop = consoleDiv.scrollHeight;
            
            console.log(logEntry);
        }

        function updateStatus(apiStatus, itemsFound, displayStatus, overallStatus) {
            document.getElementById('api-status').textContent = apiStatus;
            document.getElementById('items-found').textContent = itemsFound;
            document.getElementById('display-status').textContent = displayStatus;
            document.getElementById('overall-status').textContent = overallStatus;
        }

        async function testAPI() {
            logMessage('üîç Testing API connection and response...', 'info');
            
            try {
                const timestamp = new Date().getTime();
                const url = `api/menu.php?_t=${timestamp}`;
                
                logMessage(`Fetching from: ${url}`, 'info');
                
                const response = await fetch(url, {
                    cache: 'no-cache',
                    headers: {
                        'Cache-Control': 'no-cache',
                        'Pragma': 'no-cache'
                    }
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const data = await response.json();
                logMessage(`‚úÖ API Response: ${data.length} total items received`, 'success');
                
                return { success: true, data: data };
                
            } catch (error) {
                logMessage(`‚ùå API Error: ${error.message}`, 'error');
                return { success: false, error: error.message };
            }
        }

        function testCategoryMatching(allItems) {
            logMessage('üîç Testing category matching logic...', 'info');
            
            const matches = ['rice & curry', 'rice&curry', 'ricecurry', 'rice', 'curry'];
            logMessage(`Category patterns to match: ${matches.join(', ')}`, 'info');
            
            const riceItems = allItems.filter(item => {
                const itemCategory = item.category.toLowerCase().trim();
                const isMatch = matches.some(match => 
                    itemCategory === match || itemCategory.includes(match)
                );
                
                if (isMatch) {
                    logMessage(`‚úÖ Matched: "${item.name}" (Category: "${item.category}")`, 'success');
                }
                
                return isMatch;
            });
            
            logMessage(`üéØ Found ${riceItems.length} rice & curry items`, riceItems.length > 0 ? 'success' : 'error');
            
            return riceItems;
        }

        function displayItems(riceItems) {
            logMessage('üîç Testing item display...', 'info');
            
            const displayDiv = document.getElementById('rice-curry-display');
            
            if (riceItems.length > 0) {
                const html = riceItems.map(item => `
                    <div class="food-card">
                        <h4>${item.name}</h4>
                        <p>${item.description || 'No description available'}</p>
                        <p class="price">Rs. ${parseFloat(item.price).toFixed(2)}</p>
                        <p><strong>Category:</strong> <span class="highlight">${item.category}</span></p>
                        <p><strong>ID:</strong> ${item.id} | <strong>Available:</strong> ${item.is_available ? 'Yes' : 'No'}</p>
                    </div>
                `).join('');
                
                displayDiv.innerHTML = html;
                logMessage(`‚úÖ Successfully displayed ${riceItems.length} items`, 'success');
                
                return true;
            } else {
                displayDiv.innerHTML = '<p style="color: #dc3545; text-align: center; padding: 20px;">‚ùå No rice & curry items found to display</p>';
                logMessage('‚ùå No items to display', 'error');
                
                return false;
            }
        }

        async function runCompleteTest() {
            logMessage('üöÄ Starting comprehensive rice & curry test...', 'info');
            clearResults();
            
            const resultsDiv = document.getElementById('test-results');
            updateStatus('Testing...', '-', '-', 'Running...');
            
            // Step 1: Test API
            const apiResult = await testAPI();
            if (!apiResult.success) {
                updateStatus('Failed', '-', '-', 'Failed');
                resultsDiv.innerHTML = `<div class="step error">‚ùå API Test Failed: ${apiResult.error}</div>`;
                return;
            }
            
            updateStatus('Success', apiResult.data.length, '-', 'Running...');
            
            // Step 2: Test category matching
            const riceItems = testCategoryMatching(apiResult.data);
            updateStatus('Success', riceItems.length, '-', 'Running...');
            
            // Step 3: Test display
            const displaySuccess = displayItems(riceItems);
            updateStatus('Success', riceItems.length, displaySuccess ? 'Success' : 'Failed', displaySuccess ? 'Complete' : 'Partial');
            
            // Generate detailed results
            const resultHTML = `
                <div class="step ${apiResult.success ? 'success' : 'error'}">
                    <h3>üì° API Test Results</h3>
                    <p><strong>Status:</strong> ${apiResult.success ? '‚úÖ Success' : '‚ùå Failed'}</p>
                    <p><strong>Total Items:</strong> ${apiResult.success ? apiResult.data.length : 'N/A'}</p>
                </div>
                
                <div class="step ${riceItems.length > 0 ? 'success' : 'error'}">
                    <h3>üéØ Category Matching Results</h3>
                    <p><strong>Items Found:</strong> ${riceItems.length}</p>
                    <p><strong>Expected:</strong> 4 items (Chicken Fried Rice, Vegetable Fried Rice, Mutton Biryani, Seafood Fried Rice)</p>
                    ${riceItems.length > 0 ? `
                        <details>
                            <summary>Item Details</summary>
                            ${riceItems.map(item => `
                                <div style="margin: 5px 0; padding: 5px; background: #f8f9fa;">
                                    <strong>${item.name}</strong> - ${item.category} (ID: ${item.id})
                                </div>
                            `).join('')}
                        </details>
                    ` : ''}
                </div>
                
                <div class="step ${displaySuccess ? 'success' : 'error'}">
                    <h3>üñ•Ô∏è Display Test Results</h3>
                    <p><strong>Status:</strong> ${displaySuccess ? '‚úÖ Items displayed successfully' : '‚ùå Display failed'}</p>
                </div>
            `;
            
            resultsDiv.innerHTML = resultHTML;
            logMessage('üèÅ Comprehensive test completed!', 'success');
        }

        async function runIndividualTests() {
            logMessage('üîç Running individual diagnostic tests...', 'info');
            
            // Test 1: Basic API connectivity
            try {
                const response = await fetch('api/menu.php');
                logMessage(`‚úÖ Basic API connectivity: ${response.status} ${response.statusText}`, 'success');
            } catch (error) {
                logMessage(`‚ùå Basic API connectivity failed: ${error.message}`, 'error');
            }
            
            // Test 2: Cache headers
            try {
                const response = await fetch('api/menu.php', {
                    cache: 'no-cache',
                    headers: { 'Cache-Control': 'no-cache' }
                });
                const cacheControl = response.headers.get('Cache-Control');
                logMessage(`‚úÖ Cache headers test: ${cacheControl || 'No cache headers'}`, cacheControl ? 'success' : 'warning');
            } catch (error) {
                logMessage(`‚ùå Cache headers test failed: ${error.message}`, 'error');
            }
            
            // Test 3: Data parsing
            try {
                const response = await fetch('api/menu.php');
                const text = await response.text();
                const json = JSON.parse(text);
                logMessage(`‚úÖ JSON parsing: ${json.length} items parsed successfully`, 'success');
            } catch (error) {
                logMessage(`‚ùå JSON parsing failed: ${error.message}`, 'error');
            }
        }

        function clearResults() {
            document.getElementById('test-results').innerHTML = '';
            document.getElementById('console-log').innerHTML = 'Console cleared...';
            document.getElementById('rice-curry-display').innerHTML = '<p style="color: #666; font-style: italic;">Items will appear here after testing...</p>';
            testLog = [];
            updateStatus('Unknown', '-', 'Unknown', 'Not Started');
        }

        // Auto-run test on page load
        document.addEventListener('DOMContentLoaded', function() {
            logMessage('üåü Rice & Curry Test Tool loaded successfully', 'success');
            logMessage('Click "Run Complete Test" to start comprehensive testing', 'info');
        });
    </script>
</body>
</html>
