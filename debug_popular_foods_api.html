<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Debug Popular Foods API</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .debug-section { margin: 20px 0; padding: 15px; border: 1px solid #ccc; }
        .success { color: green; }
        .error { color: red; }
        .info { color: blue; }
        pre { background: #f5f5f5; padding: 10px; overflow-x: auto; }
    </style>
</head>
<body>
    <h1>Popular Foods API Debug</h1>
    
    <div class="debug-section">
        <h2>API Response Test</h2>
        <button onclick="testApiDirectly()">Test API Directly</button>
        <div id="apiTest"></div>
    </div>
    
    <div class="debug-section">
        <h2>loadMenuItems() Function Test</h2>
        <button onclick="testLoadMenuItems()">Test loadMenuItems() Function</button>
        <div id="loadMenuTest"></div>
    </div>
    
    <div class="debug-section">
        <h2>updatePopularFoods() Function Test</h2>
        <button onclick="testUpdatePopularFoods()">Test updatePopularFoods() with Sample Data</button>
        <div id="updateTest"></div>
    </div>
    
    <div class="debug-section">
        <h2>Popular Foods Container</h2>
        <div class="food-cards">
            <!-- This will be populated by the test -->
        </div>
    </div>

    <script>
        // Copy the functions from script.js for testing
        const API_BASE = 'api';

        async function testApiDirectly() {
            const output = document.getElementById('apiTest');
            output.innerHTML = '<p class="info">Testing API directly...</p>';
            
            try {
                const response = await fetch(`${API_BASE}/menu.php?popular=true&limit=3`);
                console.log('Response status:', response.status);
                console.log('Response headers:', response.headers);
                
                const text = await response.text();
                console.log('Raw response:', text);
                
                let data;
                try {
                    data = JSON.parse(text);
                } catch (parseError) {
                    output.innerHTML += `<p class="error">JSON Parse Error: ${parseError.message}</p>`;
                    output.innerHTML += `<p>Raw response: <pre>${text}</pre></p>`;
                    return;
                }
                
                output.innerHTML += `<p class="success">API Response Success!</p>`;
                output.innerHTML += `<pre>${JSON.stringify(data, null, 2)}</pre>`;
                
                if (Array.isArray(data) && data.length > 0) {
                    output.innerHTML += `<p class="success">Found ${data.length} popular items</p>`;
                } else {
                    output.innerHTML += `<p class="error">No popular items found or empty array</p>`;
                }
                
            } catch (error) {
                console.error('API Test Error:', error);
                output.innerHTML += `<p class="error">API Error: ${error.message}</p>`;
            }
        }

        async function testLoadMenuItems() {
            const output = document.getElementById('loadMenuTest');
            output.innerHTML = '<p class="info">Testing loadMenuItems() function...</p>';
            
            try {
                const response = await fetch(`${API_BASE}/menu.php?popular=true&limit=3`);
                const popularItems = await response.json();
                
                console.log('loadMenuItems - popularItems:', popularItems);
                output.innerHTML += `<p class="info">Received data:</p><pre>${JSON.stringify(popularItems, null, 2)}</pre>`;
                
                // Test the updatePopularFoods call
                if (Array.isArray(popularItems) && popularItems.length > 0) {
                    output.innerHTML += `<p class="success">Calling updatePopularFoods with ${popularItems.length} items</p>`;
                    updatePopularFoods(popularItems);
                } else {
                    output.innerHTML += `<p class="error">No items to pass to updatePopularFoods, calling with empty array</p>`;
                    updatePopularFoods([]);
                }
                
            } catch (error) {
                console.error('loadMenuItems Error:', error);
                output.innerHTML += `<p class="error">Error: ${error.message}</p>`;
                output.innerHTML += `<p class="info">Calling updatePopularFoods with empty array (fallback)</p>`;
                updatePopularFoods([]);
            }
        }

        function testUpdatePopularFoods() {
            const output = document.getElementById('updateTest');
            output.innerHTML = '<p class="info">Testing updatePopularFoods() with sample data...</p>';
            
            const sampleData = [
                {
                    "id": 61,
                    "name": "Special Fusion Dish",
                    "description": "Our chef special creation",
                    "price": 1200,
                    "category": "Other Specialties",
                    "image_url": "images/popular/3.png"
                },
                {
                    "id": 60,
                    "name": "Sweet and Sour Chicken", 
                    "description": "Chinese style chicken",
                    "price": 950,
                    "category": "Chinese",
                    "image_url": "images/popular/2.png"
                }
            ];
            
            console.log('Testing updatePopularFoods with:', sampleData);
            updatePopularFoods(sampleData);
            output.innerHTML += '<p class="success">updatePopularFoods called with sample data</p>';
        }

        // Copy the updatePopularFoods function from script.js
        function updatePopularFoods(items) {
            console.log('updatePopularFoods called with:', items);
            
            const foodCards = document.querySelector('.food-cards');
            if (!foodCards) {
                console.log('No food cards container found');
                return;
            }

            console.log('Updating popular foods with items:', items);

            let popularItems = [];

            // Use dynamic items from database if available
            if (items && items.length > 0) {
                popularItems = items.map(item => ({
                    id: item.id,
                    name: item.name,
                    description: item.description || `Delicious ${item.name.toLowerCase()}`,
                    price: parseFloat(item.price).toFixed(2),
                    image_url: item.image_url || 'images/popular/2.png'
                }));
                console.log('Using dynamic popular items from database');
            } else {
                // Fallback to predefined popular items when no dynamic data available
                popularItems = [
                    {
                        id: 'popular-1',
                        name: 'String Hoppers',
                        description: 'A Sri Lankan delicacy, perfect for breakfast or dinner.',
                        price: '350.00',
                        image_url: 'images/popular/1.png'
                    },
                    {
                        id: 'popular-2',
                        name: 'Kottu Roti',
                        description: 'A flavorful Sri Lankan street food favorite.',
                        price: '750.00',
                        image_url: 'images/popular/2.png'
                    },
                    {
                        id: 'popular-3',
                        name: 'Fish Ambulthiyal',
                        description: 'A tangy and spicy fish curry, unique to Sri Lanka.',
                        price: '950.00',
                        image_url: 'images/popular/3.png'
                    }
                ];
                console.log('Using fallback static popular items');
            }

            foodCards.innerHTML = popularItems.map(item => `
                <div class="food-card" style="border: 1px solid #ddd; padding: 15px; margin: 10px; border-radius: 8px;">
                    <img src="${item.image_url}" alt="${item.name}" style="width: 100%; height: 150px; object-fit: cover;"
                         onerror="console.log('Popular image failed: ${item.image_url}'); this.src='images/popular/2.png';">
                    <div class="food-card-content">
                        <h3>${item.name}</h3>
                        <p>${item.description}</p>
                        <p class="food-price"><strong>Rs. ${item.price}</strong></p>
                    </div>
                </div>
            `).join('');
        }
    </script>
</body>
</html>
