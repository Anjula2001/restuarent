<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Duplicate Reservation Investigation</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .test-section { margin: 20px 0; padding: 20px; border: 1px solid #ccc; }
        .success { background-color: #d4edda; }
        .error { background-color: #f8d7da; }
        .warning { background-color: #fff3cd; }
        button { padding: 10px 20px; margin: 10px 5px; }
        pre { background: #f4f4f4; padding: 10px; overflow-x: auto; }
        table { width: 100%; border-collapse: collapse; margin: 10px 0; }
        th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
        th { background-color: #f2f2f2; }
        .duplicate { background-color: #ffebee; }
    </style>
</head>
<body>
    <h1>Duplicate Reservation Investigation</h1>
    <p><strong>Issue:</strong> Admin panel showing duplicate reservations after form submissions</p>
    <p><strong>Date:</strong> <span id="testDate"></span></p>
    
    <div class="test-section">
        <h2>Current Database State</h2>
        <button onclick="loadCurrentReservations()">Load Current Reservations</button>
        <div id="currentReservations"></div>
    </div>
    
    <div class="test-section">
        <h2>Test Form Submission</h2>
        <p>Testing if new form submissions create duplicates</p>
        <button onclick="testFormSubmission()">Test Single Submission</button>
        <button onclick="testRapidSubmission()">Test Rapid Double Submission</button>
        <div id="submissionResults"></div>
    </div>
    
    <div class="test-section">
        <h2>Duplicate Analysis</h2>
        <button onclick="analyzeDuplicates()">Analyze Current Duplicates</button>
        <div id="duplicateAnalysis"></div>
    </div>
    
    <div class="test-section">
        <h2>Admin Panel Test</h2>
        <button onclick="testAdminPanelLoad()">Test Admin Panel Data Loading</button>
        <div id="adminPanelTest"></div>
    </div>

    <script>
        document.getElementById('testDate').textContent = new Date().toLocaleString();
        
        async function loadCurrentReservations() {
            const resultDiv = document.getElementById('currentReservations');
            resultDiv.innerHTML = '<p>Loading current reservations...</p>';
            
            try {
                const response = await fetch('/restuarent/api/reservations.php');
                const reservations = await response.json();
                
                if (Array.isArray(reservations)) {
                    let html = `<h3>Current Reservations (${reservations.length} total)</h3>`;
                    html += '<table>';
                    html += '<tr><th>ID</th><th>Name</th><th>Email</th><th>Date</th><th>Time</th><th>Status</th><th>Created</th></tr>';
                    
                    reservations.forEach(res => {
                        html += `<tr>
                            <td>${res.id}</td>
                            <td>${res.name}</td>
                            <td>${res.email}</td>
                            <td>${res.date}</td>
                            <td>${res.time}</td>
                            <td>${res.status}</td>
                            <td>${res.created_at}</td>
                        </tr>`;
                    });
                    
                    html += '</table>';
                    resultDiv.innerHTML = html;
                } else {
                    resultDiv.innerHTML = `<div class="error">
                        <p>Unexpected response format</p>
                        <pre>${JSON.stringify(reservations, null, 2)}</pre>
                    </div>`;
                }
                
            } catch (error) {
                resultDiv.innerHTML = `<div class="error">
                    <h3>❌ ERROR</h3>
                    <p>Failed to fetch reservations: ${error.message}</p>
                </div>`;
            }
        }
        
        async function testFormSubmission() {
            const resultDiv = document.getElementById('submissionResults');
            resultDiv.innerHTML = '<p>Testing single form submission...</p>';
            
            const testData = {
                name: "Investigation Test User",
                email: "investigation@test.com",
                phone: "555-INVESTIGATE",
                date: "2025-06-16",
                time: "18:00",
                guests: 2,
                special_requests: "Testing for duplicates"
            };
            
            try {
                const response = await fetch('/restuarent/api/reservations.php', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(testData)
                });
                
                const result = await response.json();
                
                if (response.ok && result.success) {
                    resultDiv.innerHTML = `<div class="success">
                        <h3>✅ SUCCESS</h3>
                        <p>Single reservation created successfully with ID: ${result.id}</p>
                        <pre>${JSON.stringify(result, null, 2)}</pre>
                    </div>`;
                } else {
                    resultDiv.innerHTML = `<div class="error">
                        <h3>❌ FAILED</h3>
                        <p>${result.error || result.message}</p>
                        <pre>${JSON.stringify(result, null, 2)}</pre>
                    </div>`;
                }
            } catch (error) {
                resultDiv.innerHTML = `<div class="error">
                    <h3>❌ ERROR</h3>
                    <p>Request failed: ${error.message}</p>
                </div>`;
            }
        }
        
        async function testRapidSubmission() {
            const resultDiv = document.getElementById('submissionResults');
            resultDiv.innerHTML = '<p>Testing rapid double submission...</p>';
            
            const testData = {
                name: "Rapid Test User",
                email: "rapid@test.com",
                phone: "555-RAPID",
                date: "2025-06-17",
                time: "19:00",
                guests: 3,
                special_requests: "Testing rapid submission"
            };
            
            try {
                // Send two identical requests immediately
                const [response1, response2] = await Promise.all([
                    fetch('/restuarent/api/reservations.php', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(testData)
                    }),
                    fetch('/restuarent/api/reservations.php', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(testData)
                    })
                ]);
                
                const [result1, result2] = await Promise.all([
                    response1.json(),
                    response2.json()
                ]);
                
                let html = '<h3>Rapid Submission Test Results:</h3>';
                
                if (response1.ok && result1.success) {
                    html += `<div class="success">
                        <p>✅ First request: SUCCESS (ID: ${result1.id})</p>
                    </div>`;
                } else {
                    html += `<div class="error">
                        <p>❌ First request: FAILED - ${result1.error || result1.message}</p>
                    </div>`;
                }
                
                if (!response2.ok || result2.error) {
                    html += `<div class="success">
                        <p>✅ Second request: PROPERLY BLOCKED</p>
                        <p>Message: ${result2.error || result2.message}</p>
                    </div>`;
                } else if (result2.success) {
                    html += `<div class="error">
                        <p>❌ Second request: NOT BLOCKED (DUPLICATE CREATED!)</p>
                        <p>ID: ${result2.id}</p>
                    </div>`;
                }
                
                resultDiv.innerHTML = html;
                
            } catch (error) {
                resultDiv.innerHTML = `<div class="error">
                    <h3>❌ ERROR</h3>
                    <p>Request failed: ${error.message}</p>
                </div>`;
            }
        }
        
        async function analyzeDuplicates() {
            const resultDiv = document.getElementById('duplicateAnalysis');
            resultDiv.innerHTML = '<p>Analyzing current duplicates...</p>';
            
            try {
                const response = await fetch('/restuarent/api/reservations.php');
                const reservations = await response.json();
                
                if (Array.isArray(reservations)) {
                    const duplicates = findDuplicates(reservations);
                    
                    let html = `<h3>Duplicate Analysis</h3>`;
                    html += `<p><strong>Total Reservations:</strong> ${reservations.length}</p>`;
                    html += `<p><strong>Duplicate Groups Found:</strong> ${duplicates.length}</p>`;
                    
                    if (duplicates.length > 0) {
                        html += '<h4>Duplicate Groups:</h4>';
                        duplicates.forEach((group, index) => {
                            html += `<div class="warning" style="margin: 10px 0; padding: 10px;">
                                <h5>Duplicate Group ${index + 1}:</h5>
                                <p><strong>Email:</strong> ${group.email}</p>
                                <p><strong>Date/Time:</strong> ${group.date} at ${group.time}</p>
                                <p><strong>IDs:</strong> ${group.ids.join(', ')}</p>
                                <p><strong>Count:</strong> ${group.count} reservations</p>
                            </div>`;
                        });
                        
                        html += '<h4>Recommended Action:</h4>';
                        html += '<p>Cancel duplicate reservations, keeping only the first one in each group.</p>';
                    } else {
                        html += '<div class="success"><p>✅ No duplicates found!</p></div>';
                    }
                    
                    resultDiv.innerHTML = html;
                } else {
                    resultDiv.innerHTML = `<div class="error">
                        <p>Invalid response format</p>
                    </div>`;
                }
                
            } catch (error) {
                resultDiv.innerHTML = `<div class="error">
                    <h3>❌ ERROR</h3>
                    <p>Failed to analyze duplicates: ${error.message}</p>
                </div>`;
            }
        }
        
        function findDuplicates(reservations) {
            const groups = {};
            
            reservations.forEach(res => {
                const key = `${res.email}|${res.date}|${res.time}`;
                if (!groups[key]) {
                    groups[key] = {
                        email: res.email,
                        date: res.date,
                        time: res.time,
                        ids: [],
                        count: 0
                    };
                }
                groups[key].ids.push(res.id);
                groups[key].count++;
            });
            
            // Return only groups with more than 1 reservation
            return Object.values(groups).filter(group => group.count > 1);
        }
        
        async function testAdminPanelLoad() {
            const resultDiv = document.getElementById('adminPanelTest');
            resultDiv.innerHTML = '<p>Testing admin panel data loading...</p>';
            
            try {
                // Simulate what the admin panel does
                const response = await fetch('/restuarent/api/reservations.php');
                const reservations = await response.json();
                
                if (Array.isArray(reservations)) {
                    let html = `<div class="success">
                        <h3>✅ Admin Panel Data Load Test</h3>
                        <p>Successfully loaded ${reservations.length} reservations</p>
                    </div>`;
                    
                    html += '<h4>Admin Panel Preview:</h4>';
                    html += '<table>';
                    html += '<tr><th>ID</th><th>Name</th><th>Email</th><th>Date</th><th>Time</th><th>Status</th></tr>';
                    
                    reservations.slice(0, 10).forEach(res => {
                        html += `<tr>
                            <td>#${res.id}</td>
                            <td>${res.name}</td>
                            <td>${res.email}</td>
                            <td>${res.date}</td>
                            <td>${res.time}</td>
                            <td>${res.status}</td>
                        </tr>`;
                    });
                    
                    if (reservations.length > 10) {
                        html += `<tr><td colspan="6"><em>... and ${reservations.length - 10} more reservations</em></td></tr>`;
                    }
                    
                    html += '</table>';
                    resultDiv.innerHTML = html;
                } else {
                    resultDiv.innerHTML = `<div class="error">
                        <p>Invalid response format</p>
                    </div>`;
                }
                
            } catch (error) {
                resultDiv.innerHTML = `<div class="error">
                    <h3>❌ ERROR</h3>
                    <p>Failed to test admin panel: ${error.message}</p>
                </div>`;
            }
        }
    </script>
</body>
</html>
