<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üéØ Final Sync Verification</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; background: #f8f9fa; }
        .container { max-width: 1200px; margin: 0 auto; }
        .test-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 30px; margin: 20px 0; }
        .test-panel { background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        .status-indicator { padding: 10px; border-radius: 5px; margin: 10px 0; text-align: center; font-weight: bold; }
        .success { background: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .fail { background: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
        .pending { background: #fff3cd; color: #856404; border: 1px solid #ffeaa7; }
        .food-item { padding: 10px; margin: 5px 0; border: 1px solid #ddd; border-radius: 5px; }
        .api-item { background: #e8f5e8; }
        .fallback-item { background: #ffe8e8; }
        .results { margin: 15px 0; }
        h1 { text-align: center; color: #333; }
        h2 { color: #555; border-bottom: 2px solid #eee; padding-bottom: 10px; }
        button { background: #007bff; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer; margin: 5px; }
        button:hover { background: #0056b3; }
        .comparison { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin: 20px 0; }
    </style>
</head>
<body>
    <div class="container">
        <h1>üéØ Popular Foods Synchronization - Final Verification</h1>
        
        <div class="status-indicator pending" id="overall-status">
            üîÑ Testing in progress...
        </div>

        <div class="test-grid">
            <!-- Homepage Test -->
            <div class="test-panel">
                <h2>üè† Homepage Test</h2>
                <button onclick="testHomepage()">Test Homepage Popular Foods</button>
                <div class="results" id="homepage-results">
                    <div class="pending">Click button to test homepage...</div>
                </div>
            </div>

            <!-- Menu Page Test -->
            <div class="test-panel">
                <h2>üìã Menu Page Test</h2>
                <button onclick="testMenuPage()">Test Menu Page Items</button>
                <div class="results" id="menu-results">
                    <div class="pending">Click button to test menu page...</div>
                </div>
            </div>
        </div>

        <div class="test-panel">
            <h2>üîç Synchronization Analysis</h2>
            <button onclick="runSyncAnalysis()">Run Complete Sync Analysis</button>
            <div class="results" id="sync-results">
                <div class="pending">Click button to run synchronization analysis...</div>
            </div>
        </div>

        <div class="comparison" id="comparison-section" style="display: none;">
            <div>
                <h3>Homepage Popular Items</h3>
                <div id="homepage-items"></div>
            </div>
            <div>
                <h3>Menu Page Matching Items</h3>
                <div id="menu-items"></div>
            </div>
        </div>
    </div>

    <script>
        let homepageData = null;
        let menuData = null;

        async function testHomepage() {
            const resultsDiv = document.getElementById('homepage-results');
            resultsDiv.innerHTML = '<div class="pending">Testing homepage...</div>';

            try {
                // Test the popular foods API endpoint
                const response = await fetch('api/menu.php?popular=true&limit=3');
                if (!response.ok) throw new Error(`API Error: ${response.status}`);
                
                const data = await response.json();
                homepageData = data;

                if (Array.isArray(data) && data.length > 0) {
                    resultsDiv.innerHTML = `
                        <div class="success">‚úÖ Homepage API Working</div>
                        <p><strong>Items Found:</strong> ${data.length}</p>
                        ${data.map(item => `
                            <div class="food-item api-item">
                                <strong>${item.name}</strong><br>
                                Category: ${item.category}<br>
                                Price: Rs. ${item.price}
                            </div>
                        `).join('')}
                    `;
                } else {
                    throw new Error('API returned empty or invalid data');
                }
            } catch (error) {
                resultsDiv.innerHTML = `
                    <div class="fail">‚ùå Homepage Test Failed</div>
                    <p>Error: ${error.message}</p>
                `;
            }
        }

        async function testMenuPage() {
            const resultsDiv = document.getElementById('menu-results');
            resultsDiv.innerHTML = '<div class="pending">Testing menu page...</div>';

            try {
                // Get all menu items
                const response = await fetch('api/menu.php');
                if (!response.ok) throw new Error(`API Error: ${response.status}`);
                
                const allItems = await response.json();
                menuData = allItems;

                // Check for items in relevant categories
                const relevantCategories = ['Other Specialties', 'Chinese', 'Seafood', 'other specialties', 'specialties'];
                const matchingItems = allItems.filter(item => 
                    relevantCategories.some(cat => 
                        item.category.toLowerCase().includes(cat.toLowerCase())
                    )
                );

                resultsDiv.innerHTML = `
                    <div class="success">‚úÖ Menu Page API Working</div>
                    <p><strong>Total Items:</strong> ${allItems.length}</p>
                    <p><strong>Relevant Category Items:</strong> ${matchingItems.length}</p>
                    ${matchingItems.slice(0, 5).map(item => `
                        <div class="food-item">
                            <strong>${item.name}</strong><br>
                            Category: ${item.category}<br>
                            Price: Rs. ${item.price}
                        </div>
                    `).join('')}
                `;
            } catch (error) {
                resultsDiv.innerHTML = `
                    <div class="fail">‚ùå Menu Page Test Failed</div>
                    <p>Error: ${error.message}</p>
                `;
            }
        }

        async function runSyncAnalysis() {
            const resultsDiv = document.getElementById('sync-results');
            const overallStatus = document.getElementById('overall-status');
            const comparisonSection = document.getElementById('comparison-section');

            resultsDiv.innerHTML = '<div class="pending">Running synchronization analysis...</div>';

            try {
                // Ensure we have both datasets
                if (!homepageData) await testHomepage();
                if (!menuData) await testMenuPage();

                if (!homepageData || !menuData) {
                    throw new Error('Failed to load required data');
                }

                // Find matching items
                const homepageItemIds = homepageData.map(item => item.id);
                const matchingMenuItems = menuData.filter(item => homepageItemIds.includes(item.id));

                const syncPercentage = (matchingMenuItems.length / homepageData.length) * 100;

                // Update comparison section
                document.getElementById('homepage-items').innerHTML = homepageData.map(item => `
                    <div class="food-item api-item">
                        <strong>${item.name}</strong><br>
                        ID: ${item.id}<br>
                        Category: ${item.category}<br>
                        Price: Rs. ${item.price}
                    </div>
                `).join('');

                document.getElementById('menu-items').innerHTML = matchingMenuItems.map(item => `
                    <div class="food-item api-item">
                        <strong>${item.name}</strong> ‚úÖ<br>
                        ID: ${item.id}<br>
                        Category: ${item.category}<br>
                        Price: Rs. ${item.price}
                    </div>
                `).join('');

                comparisonSection.style.display = 'grid';

                if (syncPercentage === 100) {
                    resultsDiv.innerHTML = `
                        <div class="success">
                            üéâ <strong>PERFECT SYNCHRONIZATION!</strong><br>
                            All ${homepageData.length} popular items from homepage are available on menu page.
                        </div>
                    `;
                    overallStatus.innerHTML = '‚úÖ Popular Foods Synchronization: COMPLETE';
                    overallStatus.className = 'status-indicator success';
                } else {
                    resultsDiv.innerHTML = `
                        <div class="fail">
                            ‚ö†Ô∏è <strong>PARTIAL SYNCHRONIZATION</strong><br>
                            ${matchingMenuItems.length}/${homepageData.length} items found (${syncPercentage.toFixed(1)}%)
                        </div>
                    `;
                    overallStatus.innerHTML = '‚ö†Ô∏è Popular Foods Synchronization: PARTIAL';
                    overallStatus.className = 'status-indicator fail';
                }

                // Additional details
                resultsDiv.innerHTML += `
                    <h4>Synchronization Details:</h4>
                    <ul>
                        <li>Homepage Popular Items: ${homepageData.length}</li>
                        <li>Menu Items Found: ${matchingMenuItems.length}</li>
                        <li>Sync Percentage: ${syncPercentage.toFixed(1)}%</li>
                        <li>API Status: Working</li>
                        <li>Data Format: Valid</li>
                    </ul>
                `;

            } catch (error) {
                resultsDiv.innerHTML = `
                    <div class="fail">‚ùå Sync Analysis Failed</div>
                    <p>Error: ${error.message}</p>
                `;
                overallStatus.innerHTML = '‚ùå Popular Foods Synchronization: FAILED';
                overallStatus.className = 'status-indicator fail';
            }
        }

        // Auto-run tests on page load
        document.addEventListener('DOMContentLoaded', function() {
            setTimeout(async () => {
                await testHomepage();
                await testMenuPage();
                await runSyncAnalysis();
            }, 1000);
        });
    </script>
</body>
</html>
